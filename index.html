<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uniform Request Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for finer control and overrides */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for longer content */
            min-height: 100vh;
            padding: 40px; /* Increased padding */
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 50px; /* More generous padding */
            border-radius: 25px; /* Even more rounded corners */
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1); /* Softer, larger shadow */
            width: 100%;
            max-width: 1000px; /* Slightly wider max-width */
            border: 1px solid #e2e8f0; /* Subtle border */
            opacity: 0; /* Start invisible for fade-in animation */
            animation: fadeIn 0.8s ease-out forwards; /* Fade-in animation */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #2c3e50; /* Darker heading color */
            font-size: 2.5rem; /* Larger main heading */
            margin-bottom: 35px; /* More space below heading */
            font-weight: 800; /* Extra bold */
            letter-spacing: -0.02em; /* Tighter letter spacing */
        }

        h2 {
            color: #34495e; /* Slightly lighter heading */
            font-size: 1.8rem; /* Larger sub-headings */
            margin-bottom: 30px;
            font-weight: 700;
            border-bottom: 2px solid #e0e6ed; /* Subtle bottom border */
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 30px; /* Increased spacing between form groups */
        }
        label {
            display: block;
            margin-bottom: 12px; /* More space below labels */
            font-weight: 700; /* Bolder labels */
            color: #4a5568; /* Darker text for labels */
            font-size: 1rem; /* Slightly larger label font */
        }
        input[type="date"],
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 16px; /* More padding in inputs */
            border: 1px solid #cbd5e1;
            border-radius: 12px; /* More rounded input fields */
            box-sizing: border-box;
            font-size: 18px; /* Slightly larger input font */
            color: #2d3748;
            background-color: #ffffff; /* White background for inputs */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06); /* Subtle inner shadow */
            transition: all 0.3s ease-in-out; /* Smooth transition for all properties */
        }
        input[type="date"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea; /* Primary blue focus color */
            box-shadow: 0 0 0 5px rgba(102, 126, 234, 0.25); /* Softer, wider focus shadow */
            background-color: #ffffff;
        }
        .item-row {
            display: grid;
            grid-template-columns: 1fr 100px 100px; /* Item, Quantity, Size */
            gap: 25px; /* Increased gap */
            align-items: center;
            margin-bottom: 20px; /* More space between item rows */
            background-color: #f8fbfd; /* Very light background for item rows */
            padding: 15px 25px;
            border-radius: 15px;
            border: 1px solid #edf2f7; /* Subtle border for item rows */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); /* Slightly stronger light shadow */
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .item-row:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .item-row label {
            margin-bottom: 0;
            font-weight: 600; /* Slightly less bold for item labels */
            font-size: 0.95rem;
            color: #334155;
        }
        .item-row input[type="number"] {
            width: 100px; /* Adjusted width */
            text-align: center;
            padding: 12px;
            font-size: 16px;
        }
        .item-row select {
            width: 100px; /* Adjusted width */
            padding: 12px;
            font-size: 16px;
        }
        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 25px; /* More space between buttons */
            margin-top: 50px; /* More space above buttons */
        }
        button {
            padding: 15px 35px; /* Larger buttons */
            border: none;
            border-radius: 15px; /* More rounded buttons */
            font-size: 18px; /* Larger font for buttons */
            font-weight: 700; /* Bolder button text */
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Smooth transitions */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12); /* Enhanced shadow */
            letter-spacing: 0.02em;
        }
        button.submit-button {
            background-color: #667eea; /* Primary blue */
            color: white;
            background-image: linear-gradient(to right, #667eea, #764ba2); /* Gradient */
        }
        button.submit-button:hover {
            background-color: #5a67d8; /* Darker blue on hover */
            background-image: linear-gradient(to right, #5a67d8, #6a4091);
            transform: translateY(-4px) scale(1.03); /* Lift and slightly enlarge */
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4); /* More prominent shadow on hover */
        }
        button.submit-button:active {
            transform: translateY(0) scale(0.98); /* Press effect */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        button.reset-button {
            background-color: #e2e8f0;
            color: #475569;
            border: 1px solid #cbd5e1;
        }
        button.reset-button:hover {
            background-color: #d6e0eb;
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.08);
        }
        button.reset-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        button.clear-button {
            background-color: #ef4444; /* Red color */
            color: white;
            background-image: linear-gradient(to right, #ef4444, #dc2626);
        }
        button.clear-button:hover {
            background-color: #cc2222;
            background-image: linear-gradient(to right, #dc2626, #b91c1c);
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 15px 30px rgba(239, 68, 68, 0.4);
        }
        button.clear-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        button.toggle-stats-button {
            background-color: #10b981; /* Green color */
            color: white;
            background-image: linear-gradient(to right, #10b981, #059669);
        }
        button.toggle-stats-button:hover {
            background-color: #0c9e6e;
            background-image: linear-gradient(to right, #059669, #047857);
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 15px 30px rgba(16, 185, 129, 0.4);
        }
        button.toggle-stats-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        button.add-stock-button {
            background-color: #3b82f6; /* Blue color */
            color: white;
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
        }
        button.add-stock-button:hover {
            background-color: #2563eb;
            background-image: linear-gradient(to right, #2563eb, #1d4ed8);
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.4);
        }
        button.add-stock-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        button.clear-stock-button {
            background-color: #f97316; /* Orange color */
            color: white;
            background-image: linear-gradient(to right, #f97316, #ea580c);
        }
        button.clear-stock-button:hover {
            background-color: #e05e0c;
            background-image: linear-gradient(to right, #ea580c, #c2410c);
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 15px 30px rgba(249, 115, 22, 0.4);
        }
        button.clear-stock-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        button.set-stock-button {
            background-color: #84cc16; /* Lime green color */
            color: white;
            background-image: linear-gradient(to right, #84cc16, #65a30d);
        }
        button.set-stock-button:hover {
            background-color: #65a30d;
            background-image: linear-gradient(to right, #65a30d, #4d7c0f);
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 15px 30px rgba(132, 204, 22, 0.4);
        }
        button.set-stock-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9); /* Start slightly smaller for animation */
            background-color: #2c3e50; /* Darker background for message box */
            color: white;
            padding: 30px 40px; /* More padding */
            border-radius: 20px; /* More rounded */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.45); /* Stronger shadow */
            z-index: 1000;
            display: none; /* Hidden by default */
            text-align: center;
            font-size: 1.2rem; /* Larger font */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother animation */
            opacity: 0;
        }
        .message-box.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .message-box button {
            background-color: #667eea; /* Primary blue button */
            color: white;
            margin-top: 25px; /* More space */
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .message-box button:hover {
            background-color: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        .message-box .confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
        }
        .message-box .confirm-buttons button {
            margin-top: 0; /* Override default button margin */
        }
        .request-list-section,
        #statsSection,
        #stockManagementSection,
        #currentStockLevelsSection,
        #stockHistorySection {
            margin-top: 60px; /* More space between main sections */
            border-top: 1px solid #e0e6ed;
            padding-top: 40px;
            background-color: #ffffff;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
        }

        .request-list-categories-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 40px; /* More space between categories */
            justify-content: space-around;
        }
        .request-list-category {
            flex: 1;
            min-width: 400px; /* Wider min-width */
            margin-bottom: 30px;
            background-color: #f8fbfd; /* Lighter background */
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .request-list-category:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }
        .charged-category {
            background-color: #fffaf0; /* Softer orange tint */
            border-color: #ffe8d6;
        }
        .uncharged-category {
            background-color: #eff6ff; /* Softer blue tint */
            border-color: #dbeafe;
        }

        .request-list-category h3 {
            font-size: 1.4rem;
            font-weight: 700;
            color: #334155;
            margin-bottom: 25px;
            text-align: center;
            border-bottom: 1px dashed #e0e6ed;
            padding-bottom: 10px;
        }
        .request-item {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .request-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }
        .request-item p {
            margin-bottom: 10px;
            color: #4a5568;
            font-size: 1rem;
        }
        .request-item strong {
            color: #1a202c;
            font-weight: 700;
        }
        .request-item ul {
            list-style: none;
            padding-left: 0;
            margin-top: 15px;
            border-top: 1px dashed #cfd8e3;
            padding-top: 15px;
        }
        .request-item ul li {
            margin-bottom: 8px;
            color: #64748b;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .user-id-display {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1em;
            color: #64748b;
            padding: 15px;
            background-color: #e0e6ed;
            border-radius: 12px;
            border: 1px solid #cdd5df;
            font-weight: 500;
        }
        
        /* Stats Section Specific */
        #statsSection .stat-card {
            background-color: #f8fbfd;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
            text-align: center;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        #statsSection .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        #statsSection .stat-card h4 {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 12px;
            font-size: 1.15rem;
        }
        #statsSection .stat-card p {
            font-size: 2rem;
            font-weight: 800;
            color: #667eea; /* Primary blue for stats numbers */
            margin-bottom: 0;
        }
        #statsSection .stat-card .item-stats {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #e0e6ed;
            text-align: left;
        }
        #statsSection .stat-card .item-stats p {
            font-size: 0.98rem;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 8px;
        }
        #statsSection .stat-card .item-stats strong {
            color: #2d3748;
        }

        /* Detailed Stock Display Section */
        #currentStockLevelsSection .stock-item-card {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        #currentStockLevelsSection .stock-item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }
        #currentStockLevelsSection .stock-item-card h4 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #334155;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px dashed #e0e6ed;
            padding-bottom: 10px;
        }
        #currentStockLevelsSection .stock-item-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #currentStockLevelsSection .stock-item-card ul li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f4f8; /* Lighter border */
            font-size: 1rem;
            color: #4a5568;
        }
        #currentStockLevelsSection .stock-item-card ul li:last-child {
            border-bottom: none;
        }
        #currentStockLevelsSection .stock-item-card ul li span:last-child {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Uniform Request Management</h1>

        <div id="userIdDisplay" class="user-id-display">
            Loading user ID...
        </div>

        <form id="uniformForm">
            <!-- Employee Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date" required>
                </div>
                <div class="form-group">
                    <label for="clockNo">Clock No.:</label>
                    <input type="text" id="clockNo" name="clockNo" required>
                </div>
                <div class="form-group md:col-span-2">
                    <label for="names">Names:</label>
                    <input type="text" id="names" name="names" required>
                </div>
            </div>

            <!-- Category Selection -->
            <div class="form-group mb-6">
                <label for="category">Category:</label>
                <select id="category" name="category" required>
                    <option value="">Select Category</option>
                    <option value="Charged">Charged</option>
                    <option value="Uncharged">Uncharged</option>
                </select>
            </div>

            <!-- Uniform Items -->
            <div class="mb-6">
                <h2 class="text-center">Uniform Items Requested</h2>

                <!-- T-shirt -->
                <div class="item-row">
                    <label for="tShirtQty">T-shirt (T):</label>
                    <input type="number" id="tShirtQty" name="tShirtQty" min="0" value="0">
                    <select id="tShirtSize" name="tShirtSize">
                        <option value="">N/A</option>
                        <option value="XS">XS</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                    </select>
                </div>

                <!-- Golfer -->
                <div class="item-row">
                    <label for="golferQty">Golfer (G):</label>
                    <input type="number" id="golferQty" name="golferQty" min="0" value="0">
                    <select id="golferSize" name="golferSize">
                        <option value="">N/A</option>
                        <option value="XS">XS</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                    </select>
                </div>

                <!-- Jacket Royal Blue (JRB) -->
                <div class="item-row">
                    <label for="jrbQty">Jacket Royal Blue (JRB):</label>
                    <input type="number" id="jrbQty" name="jrbQty" min="0" value="0">
                    <select id="jrbSize" name="jrbSize">
                        <option value="">N/A</option>
                        <option value="XS">XS</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                    </select>
                </div>

                <!-- Jacket Navy Blue (JNB) -->
                <div class="item-row">
                    <label for="jnbQty">Jacket Navy Blue (JNB):</label>
                    <input type="number" id="jnbQty" name="jnbQty" min="0" value="0">
                    <select id="jnbSize" name="jnbSize">
                        <option value="">N/A</option>
                        <option value="XS">XS</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                    </select>
                </div>

                <!-- Beanie Royal Blue / Navy Blue (BRB BNB) - Assuming one choice for simplicity -->
                <div class="item-row">
                    <label for="beanieQty">Beanie (BRB/BNB):</label>
                    <input type="number" id="beanieQty" name="beanieQty" min="0" value="0">
                    <select id="beanieColor" name="beanieColor">
                        <option value="">N/A</option>
                        <option value="Royal Blue">Royal Blue</option>
                        <option value="Navy Blue">Navy Blue</option>
                    </select>
                </div>

                <!-- Skirt (S) -->
                <div class="item-row">
                    <label for="skirtQty">Skirt (S):</label>
                    <input type="number" id="skirtQty" name="skirtQty" min="0" value="0">
                    <select id="skirtSize" name="skirtSize">
                        <option value="">N/A</option>
                        <option value="XS">XS</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                    </select>
                </div>

                <!-- Abaya (A) -->
                <div class="item-row">
                    <label for="abayaQty">Abaya (A):</label>
                    <input type="number" id="abayaQty" name="abayaQty" min="0" value="0">
                    <select id="abayaSize" name="abayaSize">
                        <option value="">N/A</option>
                        <option value="XS">XS</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                    </select>
                </div>
            </div>

            <!-- Total and Signatures (Placeholder for display) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                    <label for="total">Total Items:</label>
                    <input type="text" id="total" name="total" readonly value="0">
                </div>
                <div class="form-group">
                    <label for="totalCost">Total Cost:</label>
                    <input type="text" id="totalCost" name="totalCost" readonly value="R 0.00">
                </div>
                <div class="form-group">
                    <label for="supervisorSign">Supervisor Sign:</label>
                    <input type="text" id="supervisorSign" name="supervisorSign">
                </div>
                <div class="form-group">
                    <label for="employeeSign">Employee Sign:</label>
                    <input type="text" id="employeeSign" name="employeeSign">
                </div>
            </div>

            <div class="button-group">
                <button type="reset" class="reset-button">Reset Form</button>
                <button type="button" id="clearAllDataBtn" class="clear-button">Clear All Data</button>
                <button type="button" id="toggleStatsBtn" class="toggle-stats-button">Show/Hide Stats</button>
                <button type="submit" class="submit-button">Submit Request</button>
            </div>
        </form>

        <!-- New Stock Management Section -->
        <div id="stockManagementSection">
            <h2 class="text-center">Manage Stock</h2>

            <!-- Add Stock Section -->
            <div class="stock-input-group">
                <div class="form-group mb-0">
                    <label for="addStockItemSelect">Select Item:</label>
                    <select id="addStockItemSelect">
                        <option value="">Select Item</option>
                        <option value="tShirt">T-shirt</option>
                        <option value="golfer">Golfer</option>
                        <option value="jrb">Jacket Royal Blue</option>
                        <option value="jnb">Jacket Navy Blue</option>
                        <option value="beanie">Beanie</option>
                        <option value="skirt">Skirt</option>
                        <option value="abaya">Abaya</option>
                    </select>
                </div>
                <div class="form-group mb-0">
                    <label for="addStockSizeColorSelect">Size/Color:</label>
                    <select id="addStockSizeColorSelect">
                        <option value="">N/A</option>
                        <option value="XS">XS</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                        <option value="Royal Blue">Royal Blue</option>
                        <option value="Navy Blue">Navy Blue</option>
                    </select>
                </div>
                <div class="form-group mb-0">
                    <label for="addStockQuantityInput">Quantity to Add:</label>
                    <input type="number" id="addStockQuantityInput" min="1" value="1">
                </div>
                <div class="form-group mb-0">
                    <label for="addStockCostPrice">Cost Price (per item):</label>
                    <input type="number" id="addStockCostPrice" min="0" value="0.00" step="0.01">
                </div>
                <div class="form-group mb-0">
                    <label for="addStockAdjustedBy">Person Adding Stock:</label>
                    <input type="text" id="addStockAdjustedBy" placeholder="Name">
                </div>
                <button type="button" id="addStockBtn" class="add-stock-button">Add Stock</button>
            </div>

            <!-- Manual Stock Adjustment Section -->
            <div class="stock-input-group">
                <div class="form-group mb-0">
                    <label for="setStockItemSelect">Select Item:</label>
                    <select id="setStockItemSelect">
                        <option value="">Select Item</option>
                        <option value="tShirt">T-shirt</option>
                        <option value="golfer">Golfer</option>
                        <option value="jrb">Jacket Royal Blue</option>
                        <option value="jnb">Jacket Navy Blue</option>
                        <option value="beanie">Beanie</option>
                        <option value="skirt">Skirt</option>
                        <option value="abaya">Abaya</option>
                    </select>
                </div>
                <div class="form-group mb-0">
                    <label for="setStockSizeColorSelect">Size/Color:</label>
                    <select id="setStockSizeColorSelect">
                        <option value="">N/A</option>
                        <option value="XS">XS</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                        <option value="Royal Blue">Royal Blue</option>
                        <option value="Navy Blue">Navy Blue</option>
                    </select>
                </div>
                <div class="form-group mb-0">
                    <label for="setStockQuantityInput">Set Stock To:</label>
                    <input type="number" id="setStockQuantityInput" min="0" value="0">
                </div>
                <div class="form-group mb-0">
                    <label for="setStockAdjustedBy">Person Adjusting Stock:</label>
                    <input type="text" id="setStockAdjustedBy" placeholder="Name">
                </div>
                <button type="button" id="setStockBtn" class="set-stock-button">Set Stock Quantity</button>
            </div>

            <div class="stock-buttons">
                <div class="form-group mb-0">
                    <label for="clearStockAdjustedBy">Person Clearing Stock:</label>
                    <input type="text" id="clearStockAdjustedBy" placeholder="Name">
                </div>
                <button type="button" id="clearAllStockBtn" class="clear-stock-button">Clear All Stock</button>
            </div>
        </div>

        <div id="currentStockLevelsSection">
            <h2 class="text-center">Current Stock Levels by Size</h2>
            <div id="detailedStockDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Stock for each item will be rendered here -->
            </div>
        </div>

        <div class="request-list-section">
            <h2 class="text-center">Submitted Requests</h2>

            <div class="request-list-categories-wrapper">
                <div class="request-list-category charged-category">
                    <h3 class="text-center">Charged Requests</h3>
                    <div id="chargedRequestsContainer">
                        <p class="text-gray-500 text-center" id="noChargedRequestsMessage">No charged requests submitted yet.</p>
                    </div>
                </div>

                <div class="request-list-category uncharged-category">
                    <h3 class="text-center">Uncharged Requests</h3>
                    <div id="unchargedRequestsContainer">
                        <p class="text-gray-500 text-center" id="noUnchargedRequestsMessage">No uncharged requests submitted yet.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Hidden Stats Section -->
        <div id="statsSection">
            <h2 class="text-center">Request Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Total Requests</h4>
                    <p id="totalRequestsStat">0</p>
                </div>
                <div class="stat-card">
                    <h4>Charged Requests</h4>
                    <p id="chargedRequestsStat">0</p>
                </div>
                <div class="stat-card">
                    <h4>Uncharged Requests</h4>
                    <p id="unchargedRequestsStat">0</p>
                </div>
                <div class="stat-card">
                    <h4>Total Items Across All Requests</h4>
                    <p id="totalItemsStat">0</p>
                </div>
                <div class="stat-card">
                    <h4>Total Charged Cost</h4>
                    <p id="totalChargedCostStat">R 0.00</p>
                </div>
                <div class="stat-card">
                    <h4>Total Uncharged Cost</h4>
                    <p id="totalUnchargedCostStat">R 0.00</p>
                </div>
                <!-- Item-wise breakdown will be populated here -->
                <div class="stat-card">
                    <h4>T-shirt Quantities</h4>
                    <div class="item-stats">
                        <p>Total: <strong id="tShirtTotalStat">0</strong></p>
                        <p>Charged: <strong id="tShirtChargedStat">0</strong></p>
                        <p>Uncharged: <strong id="tShirtUnchargedStat">0</strong></p>
                        <p>Cost (Charged): <strong id="tShirtChargedCostStat">R 0.00</strong></p>
                        <p>Cost (Uncharged): <strong id="tShirtUnchargedCostStat">R 0.00</strong></p>
                        <p>Current Stock: <strong id="tShirtCurrentStockStat">0</strong></p>
                    </div>
                </div>
                <div class="stat-card">
                    <h4>Golfer Quantities</h4>
                    <div class="item-stats">
                        <p>Total: <strong id="golferTotalStat">0</strong></p>
                        <p>Charged: <strong id="golferChargedStat">0</strong></p>
                        <p>Uncharged: <strong id="golferUnchargedStat">0</strong></p>
                        <p>Cost (Charged): <strong id="golferChargedCostStat">R 0.00</strong></p>
                        <p>Cost (Uncharged): <strong id="golferUnchargedCostStat">R 0.00</strong></p>
                        <p>Current Stock: <strong id="golferCurrentStockStat">0</strong></p>
                    </div>
                </div>
                <div class="stat-card">
                    <h4>Jacket Royal Blue Quantities</h4>
                    <div class="item-stats">
                        <p>Total: <strong id="jrbTotalStat">0</strong></p>
                        <p>Charged: <strong id="jrbChargedStat">0</strong></p>
                        <p>Uncharged: <strong id="jrbUnchargedStat">0</strong></p>
                        <p>Cost (Charged): <strong id="jrbChargedCostStat">R 0.00</strong></p>
                        <p>Cost (Uncharged): <strong id="jrbUnchargedCostStat">R 0.00</strong></p>
                        <p>Current Stock: <strong id="jrbCurrentStockStat">0</strong></p>
                    </div>
                </div>
                <div class="stat-card">
                    <h4>Jacket Navy Blue Quantities</h4>
                    <div class="item-stats">
                        <p>Total: <strong id="jnbTotalStat">0</strong></p>
                        <p>Charged: <strong id="jnbChargedStat">0</strong></p>
                        <p>Uncharged: <strong id="jnbUnchargedStat">0</strong></p>
                        <p>Cost (Charged): <strong id="jnbChargedCostStat">R 0.00</strong></p>
                        <p>Cost (Uncharged): <strong id="jnbUnchargedCostStat">R 0.00</strong></p>
                        <p>Current Stock: <strong id="jnbCurrentStockStat">0</strong></p>
                    </div>
                </div>
                <div class="stat-card">
                    <h4>Beanie Quantities</h4>
                    <div class="item-stats">
                        <p>Total: <strong id="beanieTotalStat">0</strong></p>
                        <p>Charged: <strong id="beanieChargedStat">0</strong></p>
                        <p>Uncharged: <strong id="beanieUnchargedStat">0</strong></p>
                        <p>Cost (Charged): <strong id="beanieChargedCostStat">R 0.00</strong></p>
                        <p>Cost (Uncharged): <strong id="beanieUnchargedCostStat">R 0.00</strong></p>
                        <p>Current Stock: <strong id="beanieCurrentStockStat">0</strong></p>
                    </div>
                </div>
                <div class="stat-card">
                    <h4>Skirt Quantities</h4>
                    <div class="item-stats">
                        <p>Total: <strong id="skirtTotalStat">0</strong></p>
                        <p>Charged: <strong id="skirtChargedStat">0</strong></p>
                        <p>Uncharged: <strong id="skirtUnchargedStat">0</strong></p>
                        <p>Cost (Charged): <strong id="skirtChargedCostStat">R 0.00</strong></p>
                        <p>Cost (Uncharged): <strong id="skirtUnchargedCostStat">R 0.00</strong></p>
                        <p>Current Stock: <strong id="skirtCurrentStockStat">0</strong></p>
                    </div>
                </div>
                <div class="stat-card">
                    <h4>Abaya Quantities</h4>
                    <div class="item-stats">
                        <p>Total: <strong id="abayaTotalStat">0</strong></p>
                        <p>Charged: <strong id="abayaChargedStat">0</strong></p>
                        <p>Uncharged: <strong id="abayaUnchargedStat">0</strong></p>
                        <p>Cost (Charged): <strong id="abayaChargedCostStat">R 0.00</strong></p>
                        <p>Cost (Uncharged): <strong id="abayaUnchargedCostStat">R 0.00</strong></p>
                        <p>Current Stock: <strong id="abayaCurrentStockStat">0</strong></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Adjustment History Section -->
        <div id="stockHistorySection">
            <h2 class="text-center">Stock Adjustment History</h2>
            <div id="stockHistoryContainer">
                <p class="text-gray-500 text-center" id="noStockHistoryMessage">No stock adjustments recorded yet.</p>
            </div>
        </div>
    </div>

    <!-- Message Box for alerts -->
    <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <div class="confirm-buttons" id="messageBoxButtons">
            <button id="messageBoxOkBtn">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, getDocs, deleteDoc, doc, writeBatch, serverTimestamp, runTransaction, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Global variables for Canvas environment
        let appId = 'default-app-id';
        if (typeof __app_id !== 'undefined') {
            appId = __app_id;
        }

        let initialAuthToken = null;
        if (typeof __initial_auth_token !== 'undefined') {
            initialAuthToken = __initial_auth_token;
        }

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false; // Flag to indicate if Firebase auth is ready
        let currentStock = {}; // Global variable to hold current stock levels

        // Define possible sizes and colors
        const sizes = ["XS", "S", "M", "L", "XL", "XXL"];
        const colors = ["Royal Blue", "Navy Blue"];

        // Define initial stock levels and their default cost prices for each uniform item, now per size/color
        const initialStockLevels = {
            tShirt: { XS: 10, S: 20, M: 30, L: 20, XL: 10, XXL: 5, costPrice: 75.00 },
            golfer: { XS: 8, S: 15, M: 25, L: 18, XL: 10, XXL: 4, costPrice: 120.00 },
            jrb: { XS: 5, S: 10, M: 15, L: 10, XL: 6, XXL: 4, costPrice: 250.00 },
            jnb: { XS: 5, S: 10, M: 15, L: 10, XL: 6, XXL: 4, costPrice: 250.00 },
            beanie: { 'Royal Blue': 75, 'Navy Blue': 75, costPrice: 50.00 }, // Beanies have colors, not sizes
            skirt: { XS: 7, S: 12, M: 20, L: 15, XL: 10, XXL: 6, costPrice: 180.00 },
            abaya: { XS: 4, S: 8, M: 12, L: 8, XL: 5, XXL: 3, costPrice: 300.00 }
        };

        // Function to format currency
        function formatCurrency(amount) {
            return `R ${amount.toFixed(2)}`;
        }

        // Function to show custom message box
        function showMessageBox(message, type = 'alert', onConfirm = null) {
            const messageBox = document.getElementById('messageBox');
            document.getElementById('messageText').innerText = message;
            const messageBoxButtons = document.getElementById('messageBoxButtons');
            messageBoxButtons.innerHTML = ''; // Clear previous buttons

            if (type === 'confirm') {
                const yesBtn = document.createElement('button');
                yesBtn.innerText = 'Yes';
                yesBtn.className = 'submit-button';
                yesBtn.onclick = () => {
                    messageBox.classList.remove('show');
                    setTimeout(() => messageBox.style.display = 'none', 300); // Hide after animation
                    if (onConfirm) onConfirm(true);
                };
                messageBoxButtons.appendChild(yesBtn);

                const noBtn = document.createElement('button');
                noBtn.innerText = 'No';
                noBtn.className = 'reset-button';
                noBtn.onclick = () => {
                    messageBox.classList.remove('show');
                    setTimeout(() => messageBox.style.display = 'none', 300); // Hide after animation
                    if (onConfirm) onConfirm(false);
                };
                messageBoxButtons.appendChild(noBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.innerText = 'OK';
                okBtn.className = 'submit-button';
                okBtn.onclick = () => {
                    messageBox.classList.remove('show');
                    setTimeout(() => messageBox.style.display = 'none', 300); // Hide after animation
                    if (onConfirm) onConfirm(true);
                };
                messageBoxButtons.appendChild(okBtn);
            }
            messageBox.style.display = 'block';
            setTimeout(() => messageBox.classList.add('show'), 10); // Show with animation
        }

        // Firebase configuration: Directly use the provided config to ensure it's always used
        const firebaseConfig = {
            apiKey: "AIzaSyCm159uTnKBY-3Fu6bSK2dqWUJd1HJFvWg",
            authDomain: "hr-reporting-71160.firebaseapp.com",
            projectId: "hr-reporting-71160",
            storageBucket: "hr-reporting-71160.firebasestorage.app",
            messagingSenderId: "733382247099",
            appId: "1:733382247099:web:ee59c578e0c39b4ace9f9e",
            measurementId: "G-TCZWPNGGGV"
        };
        console.log("Firebase config being used:", firebaseConfig); // Log the config for debugging

        // Proceed with Firebase initialization
        let hasListenersStarted = false; // Flag to prevent multiple listener attachments
        if (firebaseConfig && typeof firebaseConfig === 'object' && firebaseConfig.projectId) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase app and services initialized successfully with provided config.");

                // Set up authentication state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('userIdDisplay').innerText = `Your User ID: ${currentUserId}`;
                        console.log("User signed in:", currentUserId);
                        isAuthReady = true; // Mark auth as ready
                        // Only start listeners if they haven't been started already
                        if (!hasListenersStarted) {
                            listenForRequests();
                            listenForStock();
                            listenForStockHistory();
                            hasListenersStarted = true; // Prevent multiple listener attachments
                        }
                    } else {
                        // If no user is signed in, attempt to sign in
                        if (!auth.currentUser) { // Only attempt if no user is currently signed in
                            try {
                                if (initialAuthToken) {
                                    console.log("Attempting to sign in with custom token...");
                                    await signInWithCustomToken(auth, initialAuthToken);
                                    console.log("Signed in with custom token.");
                                } else {
                                    console.log("No custom token provided, signing in anonymously...");
                                    await signInAnonymously(auth);
                                    console.log("Signed in anonymously.");
                                }
                                // If sign-in is successful, onAuthStateChanged will fire again with the user object.
                                // No need to set isAuthReady = true here, let the next onAuthStateChanged cycle handle it.
                            } catch (authError) {
                                console.error("Error during authentication attempt:", authError);
                                let errorMessage = "Authentication failed. Data persistence may not work.";

                                if (authError.code === 'auth/custom-token-mismatch') {
                                    console.warn("Custom token mismatch. Attempting anonymous sign-in as fallback.");
                                    try {
                                        await signInAnonymously(auth);
                                        console.log("Successfully signed in anonymously after custom token mismatch.");
                                        // The onAuthStateChanged will trigger again with the anonymous user.
                                        // Do not show error message here, as anonymous sign-in might succeed.
                                        return; // Exit to prevent further error handling in this cycle
                                    } catch (anonError) {
                                        console.error("Failed to sign in anonymously after custom token mismatch:", anonError);
                                        errorMessage += "\nFailed to sign in anonymously as well. Please check your Firebase project settings.";
                                    }
                                } else if (authError.code === 'auth/invalid-api-key') {
                                    errorMessage = "Authentication failed: Invalid API key. Please ensure your Firebase configuration is correct.";
                                } else if (authError.code === 'auth/network-request-failed') {
                                    errorMessage = "Network error during authentication. Please check your internet connection.";
                                } else {
                                    errorMessage += `\nError code: ${authError.code}. Details: ${authError.message}`;
                                }
                                showMessageBox(errorMessage);
                                isAuthReady = false; // Ensure flag is false if all auth fails
                                document.getElementById('userIdDisplay').innerText = `Authentication failed`;
                            }
                        } else {
                            // This branch means onAuthStateChanged fired with no user, but no explicit sign-in attempt was made
                            // (e.g., user signed out, or initial state is null and we are waiting for an attempt).
                            // Ensure isAuthReady is false if there's no active user.
                            isAuthReady = false;
                            document.getElementById('userIdDisplay').innerText = `Not authenticated`;
                        }
                    }
                });
            } catch (error) {
                console.error("Error during Firebase app or service initialization:", error);
                showMessageBox("Error initializing Firebase services. Data persistence will not work. Please check console for details.");
                isAuthReady = false; // Ensure flag is false if initialization fails
            }
        } else {
            console.warn("Firebase initialization skipped: Provided 'firebaseConfig' is invalid or missing 'projectId'.");
            showMessageBox("Firebase functionality is disabled. Provided configuration is invalid.");
            document.getElementById('userIdDisplay').innerText = `Firebase not initialized (config error)`;
            isAuthReady = false; // Ensure flag is false
        }

        // Get DOM elements
        const uniformForm = document.getElementById('uniformForm');
        const quantityInputs = document.querySelectorAll('input[type="number"][id$="Qty"]');
        const totalItemsInput = document.getElementById('total');
        const totalCostInput = document.getElementById('totalCost');
        const chargedRequestsContainer = document.getElementById('chargedRequestsContainer');
        const unchargedRequestsContainer = document.getElementById('unchargedRequestsContainer');
        const noChargedRequestsMessage = document.getElementById('noChargedRequestsMessage');
        const noUnchargedRequestsMessage = document.getElementById('noUnchargedRequestsMessage');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');
        const toggleStatsBtn = document.getElementById('toggleStatsBtn');
        const statsSection = document.getElementById('statsSection');
        const stockHistoryContainer = document.getElementById('stockHistoryContainer');
        const noStockHistoryMessage = document.getElementById('noStockHistoryMessage');
        const detailedStockDisplay = document.getElementById('detailedStockDisplay'); // New element for detailed stock

        // Stock Management Elements
        const addStockItemSelect = document.getElementById('addStockItemSelect');
        const addStockSizeColorSelect = document.getElementById('addStockSizeColorSelect'); // New size/color select
        const addStockQuantityInput = document.getElementById('addStockQuantityInput');
        const addStockCostPrice = document.getElementById('addStockCostPrice');
        const addStockAdjustedBy = document.getElementById('addStockAdjustedBy');
        const addStockBtn = document.getElementById('addStockBtn');

        const setStockItemSelect = document.getElementById('setStockItemSelect');
        const setStockSizeColorSelect = document.getElementById('setStockSizeColorSelect'); // New size/color select
        const setStockQuantityInput = document.getElementById('setStockQuantityInput');
        const setStockAdjustedBy = document.getElementById('setStockAdjustedBy');
        const setStockBtn = document.getElementById('setStockBtn');

        const clearStockAdjustedBy = document.getElementById('clearStockAdjustedBy');
        const clearAllStockBtn = document.getElementById('clearAllStockBtn');


        // Map item IDs to their corresponding quantity, size/color, and stock display input IDs
        const itemMap = {
            tShirt: { name: 'T-shirt', qtyId: 'tShirtQty', sizeId: 'tShirtSize', currentStockStatId: 'tShirtCurrentStockStat' },
            golfer: { name: 'Golfer', qtyId: 'golferQty', sizeId: 'golferSize', currentStockStatId: 'golferCurrentStockStat' },
            jrb: { name: 'Jacket Royal Blue', qtyId: 'jrbQty', sizeId: 'jrbSize', currentStockStatId: 'jrbCurrentStockStat' },
            jnb: { name: 'Jacket Navy Blue', qtyId: 'jnbQty', sizeId: 'jnbSize', currentStockStatId: 'jnbCurrentStockStat' },
            beanie: { name: 'Beanie', qtyId: 'beanieQty', colorId: 'beanieColor', currentStockStatId: 'beanieCurrentStockStat' },
            skirt: { name: 'Skirt', qtyId: 'skirtQty', sizeId: 'skirtSize', currentStockStatId: 'skirtCurrentStockStat' },
            abaya: { name: 'Abaya', qtyId: 'abayaQty', sizeId: 'abayaSize', currentStockStatId: 'abayaCurrentStockStat' }
        };

        // Function to update the stock display in the form and stats section
        function renderStockDisplay() {
            detailedStockDisplay.innerHTML = ''; // Clear previous display

            for (const itemType in itemMap) {
                const itemDisplayName = itemMap[itemType].name;
                // Ensure itemStockData is an object, even if currentStock[itemType] is undefined
                const itemStockData = currentStock[itemType] || {};

                const itemCard = document.createElement('div');
                itemCard.className = 'stock-item-card'; /* Use new class for detailed stock cards */
                itemCard.innerHTML = `<h4 class="font-semibold text-gray-700 mb-3">${itemDisplayName}</h4>`;

                const ul = document.createElement('ul');
                ul.className = 'list-none p-0 m-0';

                // Determine if it's a size-based item or color-based item
                const relevantOptions = (itemType === 'beanie') ? colors : sizes;

                relevantOptions.forEach(option => {
                    const stockValue = itemStockData[option] !== undefined ? itemStockData[option] : 0;
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center py-1 border-b border-gray-100 last:border-b-0';
                    let stockColor = '#4a5568'; /* Default text color */
                    if (stockValue < 5) { /* Lower threshold for individual sizes */
                        stockColor = '#e53e3e'; /* Red for very low stock */
                    } else if (stockValue < 10) {
                        stockColor = '#dd6b20'; /* Orange for low stock */
                    }
                    li.innerHTML = `<span class="text-gray-600">${option}:</span> <span style="color: ${stockColor}; font-weight: 600;">${stockValue}</span>`;
                    ul.appendChild(li);
                });
                itemCard.appendChild(ul);
                detailedStockDisplay.appendChild(itemCard);
            }
        }

        // Function to record stock adjustment in history
        async function recordStockAdjustment(itemType, quantityChange, newQuantity, adjustedBy, adjustmentType, costPrice = null, sizeOrColor = null) {
            if (!isAuthReady || !currentUserId) {
                console.warn("Firestore not ready for stock history recording.");
                return;
            }

            const stockHistoryCollectionRef = collection(db, `artifacts/${appId}/public/data/stockAdjustments`);
            const record = {
                item: itemMap[itemType] ? itemMap[itemType].name : itemType,
                quantityChange: quantityChange,
                newQuantity: newQuantity,
                adjustedBy: adjustedBy,
                adjustmentType: adjustmentType, // e.g., "Add Stock", "Set Stock", "Clear All Stock", "Request Deduction"
                timestamp: serverTimestamp(),
                userId: currentUserId
            };

            if (costPrice !== null) {
                record.costPrice = costPrice;
            }
            if (sizeOrColor !== null && sizeOrColor !== "") { // Only add if a size/color was selected
                record.sizeOrColor = sizeOrColor;
            }

            try {
                await addDoc(stockHistoryCollectionRef, record);
                console.log("Stock adjustment recorded successfully.");
            } catch (e) {
                console.error("Error recording stock adjustment:", e);
                showMessageBox("Error recording stock adjustment history. Please check console.");
            }
        }


        // Listen for real-time updates to stock levels from Firestore
        function listenForStock() {
            if (!isAuthReady) {
                console.warn("Firestore not ready for stock listener.");
                return;
            }

            const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');

            onSnapshot(stockDocRef, async (docSnapshot) => {
                if (docSnapshot.exists()) {
                    currentStock = docSnapshot.data();
                    console.log("Current stock updated from Firestore:", currentStock);
                } else {
                    // If stock document doesn't exist, initialize it with initial levels (nested)
                    console.log("Stock document not found, initializing with initial levels.");
                    currentStock = JSON.parse(JSON.stringify(initialStockLevels)); // Deep copy for initialization
                    try {
                        await setDoc(stockDocRef, {
                            ...initialStockLevels, // Set the nested initial levels
                            lastAdjustedBy: "System Initialization",
                            lastAdjustedAt: serverTimestamp()
                        });
                        console.log("Initial stock levels set in Firestore.");
                    } catch (e) {
                        console.error("Error setting initial stock levels:", e);
                        showMessageBox("Error initializing stock. Please check console.");
                    }
                }
                renderStockDisplay(); // Always render stock display after update
                updateTotalStockStats(); // Update the total stock in the stats section
            }, (error) => {
                console.error("Error listening to stock:", error);
                showMessageBox("Error loading stock data. Please check console. Also, ensure your Firebase Security Rules allow read access to 'uniformStock' for authenticated users.");
            });
        }

        // Function to update the total stock for each item in the stats section
        function updateTotalStockStats() {
            for (const itemType in itemMap) {
                const totalStockStatElement = document.getElementById(itemMap[itemType].currentStockStatId);
                if (totalStockStatElement) {
                    let totalItemStock = 0;
                    const itemStockData = currentStock[itemType] || {};
                    const relevantOptions = (itemType === 'beanie') ? colors : sizes;
                    relevantOptions.forEach(option => {
                        totalItemStock += itemStockData[option] || 0;
                    });
                    totalStockStatElement.innerText = totalItemStock;
                }
            }
        }

        // Function to create HTML for a stock history item
        function createStockHistoryItemHtml(historyItem) {
            const historyDiv = document.createElement('div');
            historyDiv.className = 'stock-history-item';
            historyDiv.innerHTML = `
                <p><strong>Item:</strong> ${historyItem.item}</p>
                <p><strong>Change:</strong> ${historyItem.quantityChange > 0 ? '+' : ''}${historyItem.quantityChange}</p>
                <p><strong>New Stock:</strong> ${historyItem.newQuantity}</p>
                ${historyItem.sizeOrColor ? `<p><strong>Size/Color:</strong> ${historyItem.sizeOrColor}</p>` : ''}
                ${historyItem.costPrice !== undefined && historyItem.costPrice !== null ? `<p><strong>Cost Price:</strong> ${formatCurrency(historyItem.costPrice)}</p>` : ''}
                <p><strong>Adjusted By:</strong> ${historyItem.adjustedBy || 'N/A'}</p>
                <p><strong>Type:</strong> ${historyItem.adjustmentType || 'N/A'}</p>
                <p class="timestamp"><strong>When:</strong> ${historyItem.timestamp ? new Date(historyItem.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
            `;
            return historyDiv;
        }

        // Listen for real-time updates to stock adjustment history
        function listenForStockHistory() {
            if (!isAuthReady) {
                console.warn("Firestore not ready for stock history listener.");
                return;
            }

            const stockHistoryCollectionRef = collection(db, `artifacts/${appId}/public/data/stockAdjustments`);
            const q = query(stockHistoryCollectionRef);

            onSnapshot(q, (snapshot) => {
                const historyItems = [];
                snapshot.forEach((doc) => {
                    historyItems.push({ id: doc.id, ...doc.data() });
                });
                // Sort history items by timestamp in descending order (newest first)
                historyItems.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                stockHistoryContainer.innerHTML = ''; // Clear previous history items
                if (historyItems.length === 0) {
                    noStockHistoryMessage.style.display = 'block';
                } else {
                    noStockHistoryMessage.style.display = 'none';
                    historyItems.forEach(item => {
                        stockHistoryContainer.appendChild(createStockHistoryItemHtml(item));
                    });
                }
                console.log("Stock history updated from Firestore.");
            }, (error) => {
                console.error("Error listening to stock history:", error);
                showMessageBox("Error loading stock history. Please check console. Also, ensure your Firebase Security Rules allow read access to 'stockAdjustments' for authenticated users.");
            });
        }


        // Function to calculate total items and total cost
        function calculateTotals() {
            let totalItems = 0;
            let totalCalculatedCost = 0;

            for (const itemType in itemMap) {
                const qtyInput = document.getElementById(itemMap[itemType].qtyId);
                const quantity = parseInt(qtyInput.value) || 0;

                totalItems += quantity;

                // Use the costPrice from currentStock, if available, otherwise default to 0
                const itemPrice = currentStock[itemType]?.costPrice !== undefined ? currentStock[itemType].costPrice : 0;
                totalCalculatedCost += quantity * itemPrice;
            }

            totalItemsInput.value = totalItems;
            totalCostInput.value = formatCurrency(totalCalculatedCost);
        }

        // Add event listeners to quantity inputs to recalculate totals on change
        quantityInputs.forEach(input => {
            input.addEventListener('input', calculateTotals);
        });

        // Set the current date as default
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
            calculateTotals();
        });

        // Function to create a request item HTML element
        function createRequestItemHtml(request) {
            const requestDiv = document.createElement('div');
            requestDiv.className = 'request-item';
            requestDiv.innerHTML = `
                <p><strong>Date:</strong> ${request.date}</p>
                <p><strong>Clock No.:</strong> ${request.clockNo}</p>
                <p><strong>Names:</strong> ${request.names}</p>
                <p><strong>Category:</strong> ${request.category || 'N/A'}</p>
                <p><strong>Total Items:</strong> ${request.totalItems}</p>
                <p><strong>Total Cost:</strong> ${formatCurrency(request.totalCost || 0)}</p>
                <p><strong>Items Requested:</strong></p>
                <ul>
                    ${Object.entries(request.items).map(([key, item]) => {
                        if (item.quantity > 0) {
                            // Use item.itemPrice if stored in the request, otherwise fallback to currentStock's costPrice
                            const itemPriceAtRequest = item.itemPrice !== undefined ? item.itemPrice : (currentStock[key]?.costPrice !== undefined ? currentStock[key].costPrice : 0);
                            const itemTotal = item.quantity * itemPriceAtRequest;
                            return `<li>- ${itemMap[key] ? itemMap[key].name : key}: Qty ${item.quantity}, Size/Color: ${item.size || item.color || 'N/A'} (Cost: ${formatCurrency(itemTotal)})</li>`;
                        }
                        return '';
                    }).join('')}
                </ul>
                <p><strong>Supervisor Sign:</strong> ${request.supervisorSign || 'N/A'}</p>
                <p><strong>Employee Sign:</strong> ${request.employeeSign || 'N/A'}</p>
                <p class="text-xs text-gray-400 mt-2">Submitted: ${request.timestamp ? new Date(request.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
            `;
            return requestDiv;
        }

        // Function to render requests into their respective containers and calculate stats
        function renderRequests(requests) {
            chargedRequestsContainer.innerHTML = '';
            unchargedRequestsContainer.innerHTML = '';

            let totalRequests = requests.length;
            let chargedRequestsCount = 0;
            let unchargedRequestsCount = 0;
            let totalItemsAcrossAllRequests = 0;
            let totalChargedCost = 0;
            let totalUnchargedCost = 0;

            // Initialize item-wise stats for requests (not current stock)
            const itemRequestStats = {
                tShirt: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                golfer: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                jrb: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                jnb: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                beanie: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                skirt: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                abaya: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
            };

            requests.forEach(request => {
                const requestDiv = createRequestItemHtml(request);

                if (request.category === 'Charged') {
                    chargedRequestsCount++;
                    chargedRequestsContainer.appendChild(requestDiv);
                    totalChargedCost += request.totalCost || 0;
                } else if (request.category === 'Uncharged') {
                    unchargedRequestsCount++;
                    unchargedRequestsContainer.appendChild(requestDiv);
                    totalUnchargedCost += request.totalCost || 0;
                }

                totalItemsAcrossAllRequests += request.totalItems || 0;

                // Aggregate item-wise quantities and costs from requests
                for (const itemType in request.items) {
                    const quantity = request.items[itemType].quantity || 0;
                    // Use item.itemPrice if stored in the request, otherwise fallback to currentStock's costPrice
                    const itemPriceAtRequest = request.items[itemType].itemPrice !== undefined ? request.items[itemType].itemPrice : (currentStock[itemType]?.costPrice !== undefined ? currentStock[itemType].costPrice : 0);
                    const itemTotalCost = quantity * itemPriceAtRequest;

                    if (itemRequestStats[itemType]) {
                        itemRequestStats[itemType].total += quantity;
                        if (request.category === 'Charged') {
                            itemRequestStats[itemType].charged += quantity;
                            itemRequestStats[itemType].chargedCost += itemTotalCost;
                        } else if (request.category === 'Uncharged') {
                            itemRequestStats[itemType].uncharged += quantity;
                            itemRequestStats[itemType].unchargedCost += itemTotalCost;
                        }
                    }
                }
            });

            // Update "No requests" messages
            if (chargedRequestsCount === 0) {
                noChargedRequestsMessage.style.display = 'block';
            } else {
                noChargedRequestsMessage.style.display = 'none';
            }

            if (unchargedRequestsCount === 0) {
                noUnchargedRequestsMessage.style.display = 'block';
            } else {
                noUnchargedRequestsMessage.style.display = 'none';
            }

            // Update stats display for requests
            document.getElementById('totalRequestsStat').innerText = totalRequests;
            document.getElementById('chargedRequestsStat').innerText = chargedRequestsCount;
            document.getElementById('unchargedRequestsStat').innerText = unchargedRequestsCount;
            document.getElementById('totalItemsStat').innerText = totalItemsAcrossAllRequests;
            document.getElementById('totalChargedCostStat').innerText = formatCurrency(totalChargedCost);
            document.getElementById('totalUnchargedCostStat').innerText = formatCurrency(totalUnchargedCost);

            document.getElementById('tShirtTotalStat').innerText = itemRequestStats.tShirt.total;
            document.getElementById('tShirtChargedStat').innerText = itemRequestStats.tShirt.charged;
            document.getElementById('tShirtUnchargedStat').innerText = itemRequestStats.tShirt.uncharged;
            document.getElementById('tShirtChargedCostStat').innerText = formatCurrency(itemRequestStats.tShirt.chargedCost);
            document.getElementById('tShirtUnchargedCostStat').innerText = formatCurrency(itemRequestStats.tShirt.unchargedCost);

            document.getElementById('golferTotalStat').innerText = itemRequestStats.golfer.total;
            document.getElementById('golferChargedStat').innerText = itemRequestStats.golfer.charged;
            document.getElementById('golferUnchargedStat').innerText = itemRequestStats.golfer.uncharged;
            document.getElementById('golferChargedCostStat').innerText = formatCurrency(itemRequestStats.golfer.chargedCost);
            document.getElementById('golferUnchargedCostStat').innerText = formatCurrency(itemRequestStats.golfer.unchargedCost);

            document.getElementById('jrbTotalStat').innerText = itemRequestStats.jrb.total;
            document.getElementById('jrbChargedStat').innerText = itemRequestStats.jrb.charged;
            document.getElementById('jrbUnchargedStat').innerText = itemRequestStats.jrb.uncharged;
            document.getElementById('jrbChargedCostStat').innerText = formatCurrency(itemRequestStats.jrb.chargedCost);
            document.getElementById('jrbUnchargedCostStat').innerText = formatCurrency(itemRequestStats.jrb.unchargedCost);

            document.getElementById('jnbTotalStat').innerText = itemRequestStats.jnb.total;
            document.getElementById('jnbChargedStat').innerText = itemRequestStats.jnb.charged;
            document.getElementById('jnbUnchargedStat').innerText = itemRequestStats.jnb.uncharged;
            document.getElementById('jnbChargedCostStat').innerText = formatCurrency(itemRequestStats.jnb.chargedCost);
            document.getElementById('jnbUnchargedCostStat').innerText = formatCurrency(itemRequestStats.jnb.unchargedCost);

            document.getElementById('beanieTotalStat').innerText = itemRequestStats.beanie.total;
            document.getElementById('beanieChargedStat').innerText = itemRequestStats.beanie.charged;
            document.getElementById('beanieUnchargedStat').innerText = itemRequestStats.beanie.uncharged;
            document.getElementById('beanieChargedCostStat').innerText = formatCurrency(itemRequestStats.beanie.chargedCost);
            document.getElementById('beanieUnchargedCostStat').innerText = formatCurrency(itemRequestStats.beanie.unchargedCost);

            document.getElementById('skirtTotalStat').innerText = itemRequestStats.skirt.total;
            document.getElementById('skirtChargedStat').innerText = itemRequestStats.skirt.charged;
            document.getElementById('skirtUnchargedStat').innerText = itemRequestStats.skirt.uncharged;
            document.getElementById('skirtChargedCostStat').innerText = formatCurrency(itemRequestStats.skirt.chargedCost);
            document.getElementById('skirtUnchargedCostStat').innerText = formatCurrency(itemRequestStats.skirt.unchargedCost);

            document.getElementById('abayaTotalStat').innerText = itemRequestStats.abaya.total;
            document.getElementById('abayaChargedStat').innerText = itemRequestStats.abaya.charged;
            document.getElementById('abayaUnchargedStat').innerText = itemRequestStats.abaya.uncharged;
            document.getElementById('abayaChargedCostStat').innerText = formatCurrency(itemRequestStats.abaya.chargedCost);
            document.getElementById('abayaUnchargedCostStat').innerText = formatCurrency(itemRequestStats.abaya.unchargedCost);

            console.log("Requests and stats updated from Firestore.");
        }

        // Listen for real-time updates from Firestore
        function listenForRequests() {
            if (!isAuthReady || !currentUserId) {
                console.warn("Firestore not ready or user not authenticated.");
                return;
            }

            const requestsCollectionRef = collection(db, `artifacts/${appId}/public/data/uniformRequests`);
            const q = query(requestsCollectionRef);

            onSnapshot(q, (snapshot) => {
                const requests = [];
                snapshot.forEach((doc) => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                requests.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                renderRequests(requests);
            }, (error) => {
                console.error("Error listening to requests:", error);
                showMessageBox("Error loading requests. Please check console. Also, ensure your Firebase Security Rules allow read access to 'uniformRequests' for authenticated users.");
            });
        }

        // Handle form submission
        uniformForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!isAuthReady || !currentUserId) {
                showMessageBox("Application is still setting up. Please wait a moment and try again.");
                return;
            }

            const formData = {
                date: document.getElementById('date').value,
                clockNo: document.getElementById('clockNo').value,
                names: document.getElementById('names').value,
                category: document.getElementById('category').value,
                items: {
                    tShirt: {
                        quantity: parseInt(document.getElementById('tShirtQty').value) || 0,
                        size: document.getElementById('tShirtSize').value,
                        itemPrice: currentStock.tShirt?.costPrice !== undefined ? currentStock.tShirt.costPrice : 0
                    },
                    golfer: {
                        quantity: parseInt(document.getElementById('golferQty').value) || 0,
                        size: document.getElementById('golferSize').value,
                        itemPrice: currentStock.golfer?.costPrice !== undefined ? currentStock.golfer.costPrice : 0
                    },
                    jrb: {
                        quantity: parseInt(document.getElementById('jrbQty').value) || 0,
                        size: document.getElementById('jrbSize').value,
                        itemPrice: currentStock.jrb?.costPrice !== undefined ? currentStock.jrb.costPrice : 0
                    },
                    jnb: {
                        quantity: parseInt(document.getElementById('jnbQty').value) || 0,
                        size: document.getElementById('jnbSize').value,
                        itemPrice: currentStock.jnb?.costPrice !== undefined ? currentStock.jnb.costPrice : 0
                    },
                    beanie: {
                        quantity: parseInt(document.getElementById('beanieQty').value) || 0,
                        color: document.getElementById('beanieColor').value,
                        itemPrice: currentStock.beanie?.costPrice !== undefined ? currentStock.beanie.costPrice : 0
                    },
                    skirt: {
                        quantity: parseInt(document.getElementById('skirtQty').value) || 0,
                        size: document.getElementById('skirtSize').value,
                        itemPrice: currentStock.skirt?.costPrice !== undefined ? currentStock.skirt.costPrice : 0
                    },
                    abaya: {
                        quantity: parseInt(document.getElementById('abayaQty').value) || 0,
                        size: document.getElementById('abayaSize').value,
                        itemPrice: currentStock.abaya?.costPrice !== undefined ? currentStock.abaya.costPrice : 0
                    }
                },
                totalItems: parseInt(document.getElementById('total').value) || 0,
                totalCost: parseFloat(totalCostInput.value.replace('R ', '')) || 0,
                supervisorSign: document.getElementById('supervisorSign').value,
                employeeSign: document.getElementById('employeeSign').value,
                timestamp: serverTimestamp(),
                submittedBy: currentUserId
            };

            if (!formData.date || !formData.clockNo || !formData.names || !formData.category) {
                showMessageBox("Please fill in all required employee details and select a category.");
                return;
            }

            const hasRequestedItems = Object.values(formData.items).some(item => item.quantity > 0);
            if (!hasRequestedItems) {
                showMessageBox("Please request at least one uniform item.");
                return;
            }

            const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockDocRef);
                    if (!stockDoc.exists()) {
                        throw new Error("Stock data not found. Please refresh the page.");
                    }

                    const currentStockInDb = stockDoc.data();
                    const newStockData = JSON.parse(JSON.stringify(currentStockInDb)); // Deep copy to modify nested objects
                    let insufficientStockMessage = "";

                    const deductions = {}; // To record for stock history
                    for (const itemType in formData.items) {
                        const requestedQty = formData.items[itemType].quantity;
                        if (requestedQty > 0) {
                            const requestedSizeOrColor = formData.items[itemType].size || formData.items[itemType].color;

                            if (!requestedSizeOrColor || requestedSizeOrColor === 'N/A') {
                                insufficientStockMessage += `Please select a size/color for ${itemMap[itemType].name}.\n`;
                                continue;
                            }

                            // Ensure the itemType and size/color path exists in stock data
                            if (!newStockData[itemType]) {
                                newStockData[itemType] = {};
                            }
                            if (newStockData[itemType][requestedSizeOrColor] === undefined) {
                                newStockData[itemType][requestedSizeOrColor] = 0; // Initialize if not present
                            }

                            const availableStock = newStockData[itemType][requestedSizeOrColor];

                            if (requestedQty > availableStock) {
                                insufficientStockMessage += `Insufficient stock for ${itemMap[itemType].name} (Size/Color: ${requestedSizeOrColor}). Requested: ${requestedQty}, Available: ${availableStock}.\n`;
                            } else {
                                newStockData[itemType][requestedSizeOrColor] -= requestedQty;
                                // Store deduction details for history, including size/color
                                if (!deductions[itemType]) deductions[itemType] = {};
                                deductions[itemType][requestedSizeOrColor] = requestedQty;
                            }
                        }
                    }

                    if (insufficientStockMessage) {
                        throw new Error(insufficientStockMessage);
                    }

                    transaction.update(stockDocRef, newStockData);
                    const newRequestDocRef = doc(collection(db, `artifacts/${appId}/public/data/uniformRequests`));
                    transaction.set(newRequestDocRef, formData);

                    // Record deductions in stock history, now per size/color
                    for (const itemType in deductions) {
                        for (const sizeOrColorDeducted in deductions[itemType]) {
                            await recordStockAdjustment(
                                itemType,
                                -deductions[itemType][sizeOrColorDeducted],
                                newStockData[itemType][sizeOrColorDeducted], // New quantity for that specific size/color
                                formData.names,
                                "Request Deduction",
                                formData.items[itemType].itemPrice, // Pass the itemPrice from the formData
                                sizeOrColorDeducted
                            );
                        }
                    }
                });

                console.log("Uniform request submitted and stock updated successfully.");
                showMessageBox("Uniform request submitted successfully!");
                uniformForm.reset();
                calculateTotals();
            }
            catch (e) {
                console.error("Error during transaction:", e);
                if (e.message.includes("Insufficient stock")) {
                    showMessageBox(e.message);
                } else {
                    showMessageBox("Error submitting request or updating stock. Please try again. Details: " + e.message + "\nEnsure your Firebase Security Rules allow write access to 'uniformRequests' and 'uniformStock' for authenticated users.");
                }
            }
        });

        // Handle form reset
        uniformForm.addEventListener('reset', function() {
            quantityInputs.forEach(input => {
                input.value = 0;
            });
            document.querySelectorAll('select[id$="Size"], select[id$="Color"]').forEach(select => {
                select.value = "";
            });
            document.getElementById('category').value = "";
            calculateTotals();
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
        });

        // Handle Clear All Data button click
        clearAllDataBtn.addEventListener('click', () => {
            showMessageBox("Are you sure you want to delete ALL uniform request data AND reset stock levels? This action cannot be undone.", 'confirm', async (confirmed) => {
                if (confirmed) {
                    if (!isAuthReady || !currentUserId) {
                        showMessageBox("Application is not ready. Please wait for Firebase to initialize.");
                        return;
                    }

                    try {
                        const requestsCollectionRef = collection(db, `artifacts/${appId}/public/data/uniformRequests`);
                        const requestsQuerySnapshot = await getDocs(query(requestsCollectionRef));
                        const batch = writeBatch(db);
                        requestsQuerySnapshot.forEach((document) => {
                            batch.delete(doc(db, `artifacts/${appId}/public/data/uniformRequests`, document.id));
                        });

                        const stockHistoryCollectionRef = collection(db, `artifacts/${appId}/public/data/stockAdjustments`);
                        const stockHistoryQuerySnapshot = await getDocs(query(stockHistoryCollectionRef));
                        stockHistoryQuerySnapshot.forEach((document) => {
                            batch.delete(doc(db, `artifacts/${appId}/public/data/stockAdjustments`, document.id));
                        });

                        const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');
                        // Set stock to initial levels, which are now nested
                        batch.set(stockDocRef, initialStockLevels);

                        await batch.commit();
                        console.log("All uniform request data cleared and stock reset to initial levels successfully.");
                        showMessageBox("All uniform request data has been cleared and stock levels reset to initial quantities.");
                    } catch (e) {
                        console.error("Error clearing all data or resetting stock: ", e);
                        showMessageBox("Error clearing data or resetting stock. Please check console for details. Ensure your Firebase Security Rules allow write access to these collections for authenticated users.");
                    }
                }
            });
        });

        // Handle Toggle Stats button click
        toggleStatsBtn.addEventListener('click', () => {
            if (statsSection.style.display === 'none' || statsSection.style.display === '') {
                statsSection.style.display = 'block';
            } else {
                statsSection.style.display = 'none';
            }
        });

        // Handle Add Stock button click
        addStockBtn.addEventListener('click', async () => {
            if (!isAuthReady || !currentUserId) {
                showMessageBox("Application is not ready. Please wait for Firebase to initialize.");
                return;
            }

            const selectedItem = addStockItemSelect.value;
            const sizeOrColor = addStockSizeColorSelect.value; // Get selected size/color
            const quantityToAdd = parseInt(addStockQuantityInput.value);
            const costPrice = parseFloat(addStockCostPrice.value);
            const adjustedBy = addStockAdjustedBy.value.trim();

            if (!selectedItem) {
                showMessageBox("Please select an item to add stock for.");
                return;
            }
            if (!sizeOrColor || sizeOrColor === 'N/A') {
                showMessageBox("Please select a size/color for the item.");
                return;
            }
            if (isNaN(quantityToAdd) || quantityToAdd <= 0) {
                showMessageBox("Please enter a valid quantity to add (must be a positive number).");
                return;
            }
            if (isNaN(costPrice) || costPrice < 0) {
                showMessageBox("Please enter a valid cost price (must be a non-negative number).");
                return;
            }
            if (!adjustedBy) {
                showMessageBox("Please enter your name as the person adding stock.");
                return;
            }

            const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockDocRef);
                    let currentStockInDb = {};
                    if (stockDoc.exists()) {
                        currentStockInDb = stockDoc.data();
                    } else {
                        // Initialize with zero levels for all sizes if doc doesn't exist
                        for (const itemType in initialStockLevels) {
                            currentStockInDb[itemType] = {};
                            const relevantOptions = (itemType === 'beanie') ? colors : sizes;
                            relevantOptions.forEach(option => {
                                currentStockInDb[itemType][option] = 0;
                            });
                            currentStockInDb[itemType].costPrice = 0; // Initialize costPrice as well
                        }
                        console.log("Stock document not found, initializing with zero levels for add stock.");
                    }

                    const newStockData = JSON.parse(JSON.stringify(currentStockInDb)); // Deep copy

                    // Ensure the itemType and size/color path exists
                    if (!newStockData[selectedItem]) {
                        newStockData[selectedItem] = {};
                    }
                    if (newStockData[selectedItem][sizeOrColor] === undefined) {
                        newStockData[selectedItem][sizeOrColor] = 0;
                    }

                    const currentQty = newStockData[selectedItem][sizeOrColor];
                    const updatedQty = currentQty + quantityToAdd;

                    newStockData[selectedItem][sizeOrColor] = updatedQty;
                    // Update the cost price for the specific item type
                    newStockData[selectedItem].costPrice = costPrice;
                    newStockData.lastAdjustedBy = adjustedBy;
                    newStockData.lastAdjustedAt = serverTimestamp();

                    transaction.set(stockDocRef, newStockData); // Use setDoc to ensure it creates if not exists

                    await recordStockAdjustment(
                        selectedItem,
                        quantityToAdd,
                        updatedQty,
                        adjustedBy,
                        "Add Stock",
                        costPrice,
                        sizeOrColor
                    );
                });

                showMessageBox(`${quantityToAdd} units of ${itemMap[selectedItem].name} (Size/Color: ${sizeOrColor}) added to stock successfully by ${adjustedBy} at ${formatCurrency(costPrice)} per item!`);
                addStockItemSelect.value = "";
                addStockSizeColorSelect.value = ""; // Reset size/color
                addStockQuantityInput.value = 1;
                addStockCostPrice.value = 0.00;
                addStockAdjustedBy.value = "";
            } catch (e) {
                console.error("Error adding stock:", e);
                showMessageBox("Error adding stock. Please try again. Details: " + e.message + "\nEnsure your Firebase Security Rules allow write access to 'uniformStock' and 'stockAdjustments' for authenticated users.");
            }
        });

        // Handle Set Stock Quantity button click
        setStockBtn.addEventListener('click', async () => {
            if (!isAuthReady || !currentUserId) {
                showMessageBox("Application is not ready. Please wait for Firebase to initialize.");
                return;
            }

            const selectedItem = setStockItemSelect.value;
            const sizeOrColor = setStockSizeColorSelect.value; // Get selected size/color
            const quantityToSet = parseInt(setStockQuantityInput.value);
            const adjustedBy = setStockAdjustedBy.value.trim();

            if (!selectedItem) {
                showMessageBox("Please select an item to set stock for.");
                return;
            }
            if (!sizeOrColor || sizeOrColor === 'N/A') {
                showMessageBox("Please select a size/color for the item.");
                return;
            }
            if (isNaN(quantityToSet) || quantityToSet < 0) {
                showMessageBox("Please enter a valid quantity to set (must be a non-negative number).");
                return;
            }
            if (!adjustedBy) {
                showMessageBox("Please enter your name as the person adjusting stock.");
                return;
            }

            const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockDocRef);
                    let currentStockInDb = {};
                    if (stockDoc.exists()) {
                        currentStockInDb = stockDoc.data();
                    } else {
                        // Initialize with zero levels for all sizes if doc doesn't exist
                        for (const itemType in initialStockLevels) {
                            currentStockInDb[itemType] = {};
                            const relevantOptions = (itemType === 'beanie') ? colors : sizes;
                            relevantOptions.forEach(option => {
                                currentStockInDb[itemType][option] = 0;
                            });
                            currentStockInDb[itemType].costPrice = 0; // Initialize costPrice as well
                        }
                        console.log("Stock document not found, initialized with zero levels for set stock.");
                    }

                    const newStockData = JSON.parse(JSON.stringify(currentStockInDb)); // Deep copy

                    // Ensure the itemType and size/color path exists
                    if (!newStockData[selectedItem]) {
                        newStockData[selectedItem] = {};
                    }
                    if (newStockData[selectedItem][sizeOrColor] === undefined) {
                        newStockData[selectedItem][sizeOrColor] = 0;
                    }

                    const oldQty = newStockData[selectedItem][sizeOrColor];
                    const quantityChange = quantityToSet - oldQty;

                    newStockData[selectedItem][sizeOrColor] = quantityToSet;
                    newStockData.lastAdjustedBy = adjustedBy;
                    newStockData.lastAdjustedAt = serverTimestamp();

                    transaction.set(stockDocRef, newStockData); // Use setDoc to ensure it creates if not exists

                    await recordStockAdjustment(
                        selectedItem,
                        quantityChange,
                        quantityToSet,
                        adjustedBy,
                        "Set Stock",
                        null, // No specific cost price for a general set operation
                        sizeOrColor
                    );
                });

                showMessageBox(`${itemMap[selectedItem].name} stock set to ${quantityToSet} (Size/Color: ${sizeOrColor}) by ${adjustedBy}!`);
                setStockItemSelect.value = "";
                setStockSizeColorSelect.value = ""; // Reset size/color
                setStockQuantityInput.value = 0;
                setStockAdjustedBy.value = "";
            } catch (e) {
                console.error("Error setting stock:", e);
                showMessageBox("Error setting stock. Please try again. Details: " + e.message + "\nEnsure your Firebase Security Rules allow write access to 'uniformStock' and 'stockAdjustments' for authenticated users.");
            }
        });


        // Handle Clear All Stock button click (modified to set stock to zero)
        clearAllStockBtn.addEventListener('click', () => {
            showMessageBox("Are you sure you want to clear ALL stock levels to zero? This action cannot be undone.", 'confirm', async (confirmed) => {
                if (confirmed) {
                    if (!isAuthReady || !currentUserId) {
                        showMessageBox("Application is not ready. Please wait for Firebase to initialize.");
                        return;
                    }

                    const adjustedBy = clearStockAdjustedBy.value.trim();
                    if (!adjustedBy) {
                        showMessageBox("Please enter your name as the person clearing stock.");
                        return;
                    }

                    const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');
                    console.log("Attempting to clear all stock to zero. Stock document ref path:", stockDocRef.path);

                    try {
                        await runTransaction(db, async (transaction) => {
                            const stockDoc = await transaction.get(stockDocRef);
                            let currentStockInDb = {};
                            if (stockDoc.exists()) {
                                currentStockInDb = stockDoc.data();
                            } else {
                                // If doc doesn't exist, initialize with zero for all sizes
                                for (const itemType in initialStockLevels) {
                                    currentStockInDb[itemType] = {};
                                    const relevantOptions = (itemType === 'beanie') ? colors : sizes;
                                    relevantOptions.forEach(option => {
                                        currentStockInDb[itemType][option] = 0;
                                    });
                                    currentStockInDb[itemType].costPrice = 0; // Initialize costPrice as well
                                }
                                console.log("Stock document not found, initializing with zero levels for clear stock.");
                            }

                            const zeroStockLevelsNested = {};
                            let totalChange = 0;
                            for (const itemType in initialStockLevels) { // Iterate through all known item types
                                zeroStockLevelsNested[itemType] = {};
                                const relevantOptions = (itemType === 'beanie') ? colors : sizes;
                                relevantOptions.forEach(option => {
                                    const oldQty = currentStockInDb[itemType]?.[option] || 0;
                                    totalChange -= oldQty;
                                    zeroStockLevelsNested[itemType][option] = 0;
                                });
                                zeroStockLevelsNested[itemType].costPrice = currentStockInDb[itemType]?.costPrice || 0; // Preserve existing cost price
                            }

                            console.log("Inside transaction: Setting stock to zero levels.");
                            transaction.set(stockDocRef, {
                                ...zeroStockLevelsNested,
                                lastAdjustedBy: adjustedBy,
                                lastAdjustedAt: serverTimestamp()
                            });

                            await recordStockAdjustment(
                                "all_items",
                                totalChange,
                                0, // New quantity for "all_items" is effectively 0
                                adjustedBy,
                                "Clear All Stock",
                                null, // No specific cost price for clearing all stock
                                "All Sizes/Colors" // Indicate all sizes/colors were cleared
                            );
                        });
                        console.log("All stock levels reset to zero successfully.");
                        showMessageBox(`All stock levels have been reset to zero by ${adjustedBy}.`);
                        clearStockAdjustedBy.value = "";
                    } catch (e) {
                        console.error("Error clearing all stock to zero: ", e);
                        showMessageBox("Error clearing all stock to zero. Please check console for details. Ensure your Firebase Security Rules allow write access to 'uniformStock' and 'stockAdjustments' for authenticated users.");
                    }
                }
            });
        });

        console.log("Uniform Request Application script loaded and initialized.");

    </script>
</body>
</html>
