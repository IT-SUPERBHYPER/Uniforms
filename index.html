<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Uniform Request Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        /* Custom CSS for girly theme */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --primary: #e91e63;
            --primary-light: #f8bbd9;
            --primary-dark: #ad1457;
            --secondary: #9c27b0;
            --accent: #ff4081;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --info: #2196f3;
            --dark: #4a148c;
            --light: #fce4ec;
            --gray: #8e8e93;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f4f9;
            --text-primary: #4a148c;
            --text-secondary: #7b1fa2;
            --border-color: #e1bee7;
            --card-bg: #ffffff;
            --hover-bg: #f3e5f5;
            --gradient-start: #e91e63;
            --gradient-end: #9c27b0;
        }

        [data-theme="dark"] {
            --primary: #f48fb1;
            --primary-light: #fce4ec;
            --primary-dark: #ad1457;
            --secondary: #ce93d8;
            --accent: #ff80ab;
            --success: #81c784;
            --warning: #ffb74d;
            --danger: #e57373;
            --info: #64b5f6;
            --dark: #f3e5f5;
            --light: #4a148c;
            --gray: #b39ddb;
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --text-primary: #f3e5f5;
            --text-secondary: #ce93d8;
            --border-color: #7e57c2;
            --card-bg: #16213e;
            --hover-bg: #0f3460;
            --gradient-start: #f48fb1;
            --gradient-end: #ce93d8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", sans-serif;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 15px;
            position: relative;
            overflow-x: hidden;
            color: var(--text-primary);
            /* Prevent pull-to-refresh on mobile interfering with app feel */
            overscroll-behavior-y: none; 
        }

        [data-theme="dark"] body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="none"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></svg>');
            z-index: -1;
        }

        .container {
            background: var(--bg-primary);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 1200px;
            border: 1px solid var(--border-color);
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: var(--text-primary);
            font-size: 2rem;
            margin-bottom: 20px;
            font-weight: 800;
            letter-spacing: -0.02em;
            text-align: center;
            position: relative;
            padding-bottom: 15px;
        }

        h1::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
        }

        h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: 700;
            position: relative;
            padding-bottom: 10px;
            text-align: center;
        }

        h2::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            position: relative;
        }

        label i {
            margin-right: 8px;
            color: var(--primary);
        }

        input[type="date"],
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 14px;
            color: var(--text-primary);
            background-color: var(--card-bg);
            transition: all 0.3s ease;
        }

        input[type="date"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.2);
        }

        .item-row {
            display: grid;
            grid-template-columns: 1fr 80px 80px;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .item-row::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
        }

        .item-row:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .item-row label {
            margin-bottom: 0;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .item-row input[type="number"] {
            width: 100%;
            text-align: center;
            padding: 8px;
            font-size: 14px;
        }

        .item-row select {
            width: 100%;
            padding: 8px;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
            width: 100%;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
            flex: 1;
            justify-content: center;
            min-width: 120px;
        }

        button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.5s ease;
        }

        button:hover::before {
            left: 100%;
        }

        button.submit-button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 6px -1px rgba(233, 30, 99, 0.3);
        }

        button.submit-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(233, 30, 99, 0.3);
        }

        button.reset-button {
            background: linear-gradient(135deg, #8e8e93, #5d5d63);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(142, 142, 147, 0.3);
        }

        button.reset-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(142, 142, 147, 0.3);
        }

        button.clear-button {
            background: linear-gradient(135deg, var(--danger), #d32f2f);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(244, 67, 54, 0.3);
        }

        button.clear-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(244, 67, 54, 0.3);
        }

        button.toggle-stats-button {
            background: linear-gradient(135deg, var(--success), #388e3c);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(76, 175, 80, 0.3);
        }

        button.toggle-stats-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(76, 175, 80, 0.3);
        }

        button.add-stock-button {
            background: linear-gradient(135deg, var(--info), #1976d2);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(33, 150, 243, 0.3);
        }

        button.add-stock-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(33, 150, 243, 0.3);
        }

        button.clear-stock-button {
            background: linear-gradient(135deg, var(--warning), #f57c00);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(255, 152, 0, 0.3);
        }

        button.clear-stock-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(255, 152, 0, 0.3);
        }

        button.set-stock-button {
            background: linear-gradient(135deg, var(--accent), #c2185b);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(255, 64, 129, 0.3);
        }

        button.set-stock-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(255, 64, 129, 0.3);
        }

        button.dispatch-button {
            background: linear-gradient(135deg, var(--success), #2e7d32);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(76, 175, 80, 0.3);
        }

        button.dispatch-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(76, 175, 80, 0.3);
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            display: none;
            text-align: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            opacity: 0;
            max-width: 90%;
            width: 450px;
        }

        .message-box.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .message-box button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            margin-top: 15px;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: auto;
        }

        .message-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(233, 30, 99, 0.3);
        }

        .message-box .confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .collapsible-section {
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--card-bg);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .section-header:hover {
            background-color: var(--hover-bg);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .section-toggle {
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .section-toggle.collapsed {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            background-color: var(--bg-secondary);
        }

        .section-content.expanded {
            padding: 20px;
            max-height: 10000px;
            transition: max-height 0.5s ease-in, padding 0.3s ease-in;
        }

        .request-list-section,
        #statsSection,
        #stockManagementSection,
        #currentStockLevelsSection,
        #stockHistorySection {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .request-list-categories-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
        }

        .request-list-category {
            flex: 1;
            min-width: 250px;
            margin-bottom: 15px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .request-list-category::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
        }

        .charged-category::before {
            background: linear-gradient(90deg, var(--warning), #f57c00);
        }

        .uncharged-category::before {
            background: linear-gradient(90deg, var(--info), #1976d2);
        }

        .pending-dispatch-category::before {
            background: linear-gradient(90deg, var(--warning), #ff9800);
        }

        .dispatched-category::before {
            background: linear-gradient(90deg, var(--success), #4caf50);
        }

        .request-list-category:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .request-list-category h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 8px;
        }

        .request-item {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .request-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .request-item.pending-dispatch {
            border-left: 4px solid var(--warning);
        }

        .request-item.dispatched {
            border-left: 4px solid var(--success);
        }

        .request-item p {
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .request-item strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .request-item ul {
            list-style: none;
            padding-left: 0;
            margin-top: 8px;
            border-top: 1px dashed var(--border-color);
            padding-top: 8px;
        }

        .request-item ul li {
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .request-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .request-item-actions button {
            padding: 6px 12px;
            font-size: 0.8rem;
            min-width: 0;
            flex: none;
        }

        .signature-box {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: white;
            cursor: crosshair;
            /* Critical for Android: Prevent default touch actions (scrolling) */
            touch-action: none !important; 
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            width: 100%;
            height: 200px;
            display: block;
            position: relative;
            overflow: hidden; /* Ensure signature doesn't bleed out */
        }

        .signature-pad-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .signature-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .signature-actions button {
            min-width: 120px;
        }

        .signature-display {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            background: white;
            margin-top: 10px;
            max-width: 300px;
        }

        .signature-display img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* New styles for signature display in dispatched items */
        .signature-display-small {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 5px;
            background: white;
            margin-top: 8px;
            max-width: 200px;
        }

        .signature-display-small img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .signature-thumbnail {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.7rem;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            margin-left: 10px;
        }

        .signature-thumbnail.has-signature {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .user-id-display {
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connection-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .connection-status.connected {
            background: #10b981;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--hover-bg);
        }

        /* Stats Section Specific */
        #statsSection .stat-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #statsSection .stat-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        #statsSection .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #statsSection .stat-card h4 {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        #statsSection .stat-card p {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0;
        }

        #statsSection .stat-card .item-stats {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            text-align: left;
        }

        #statsSection .stat-card .item-stats p {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        #statsSection .stat-card .item-stats strong {
            color: var(--text-primary);
        }

        /* Stock Management Section */
        .stock-input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stock-buttons {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Detailed Stock Display Section */
        #currentStockLevelsSection .stock-item-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #currentStockLevelsSection .stock-item-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        #currentStockLevelsSection .stock-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #currentStockLevelsSection .stock-item-card h4 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
            text-align: center;
            padding-bottom: 8px;
        }

        #currentStockLevelsSection .stock-item-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #currentStockLevelsSection .stock-item-card ul li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        #currentStockLevelsSection .stock-item-card ul li:last-child {
            border-bottom: none;
        }

        #currentStockLevelsSection .stock-item-card ul li span:last-child {
            font-weight: 600;
        }

        /* Stock History Section */
        .stock-history-item {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .stock-history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .stock-history-item p {
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stock-history-item strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .timestamp {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* New UI Improvements */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dashboard-stat {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .dashboard-stat:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .dashboard-stat h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .dashboard-stat p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
            justify-content: center;
        }

        .quick-action-btn:hover {
            background: var(--hover-bg);
            transform: translateY(-2px);
        }

        .quick-action-btn i {
            color: var(--primary);
        }

        .form-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .form-section h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section h3 i {
            color: var(--primary);
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .item-card {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-card-header h4 {
            color: var(--text-primary);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item-card-header h4 i {
            color: var(--primary);
        }

        .item-card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .item-card-body .form-group {
            margin-bottom: 0;
        }

        .item-card-body label {
            font-size: 0.8rem;
        }

        .item-card-body input,
        .item-card-body select {
            padding: 8px;
            font-size: 0.9rem;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-dispatched {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-charged {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-uncharged {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Dispatch status section */
        .dispatch-status-info {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border-left: 4px solid var(--info);
        }

        .dispatch-status-info p {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Signature Modal Styles */
        #signatureModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            text-align: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            opacity: 0;
            max-width: 95%;
            width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            /* Prevent scrolling of the modal itself interfering with canvas */
            touch-action: pan-y; 
        }

        #signatureModal.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        #signatureModal h3 {
            color: var(--text-primary);
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }

        .modal-backdrop.show {
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.2rem;
            }

            .item-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            button {
                width: 100%;
                max-width: 250px;
            }

            .stock-input-group {
                grid-template-columns: 1fr;
            }

            .stock-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .request-list-categories-wrapper {
                flex-direction: column;
            }

            .request-list-category {
                min-width: 100%;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .quick-actions {
                width: 100%;
            }

            .quick-action-btn {
                min-width: 100%;
            }

            .items-grid {
                grid-template-columns: 1fr;
            }

            .request-item-actions {
                flex-direction: column;
            }

            .signature-actions {
                flex-direction: column;
            }

            #signatureModal {
                width: 95%;
                padding: 15px;
            }
        }

        /* FIX: Specific Canvas Styles for Android/Touch */
        #signaturePad {
            /* Critical: Disables browser handling of gestures (scrolling/zooming) inside canvas */
            touch-action: none !important; 
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            width: 100%;
            height: 200px;
            display: block;
        }
    </style>
<base target="_blank">
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <h1><i class="fas fa-tshirt"></i> Uniform Request & Dispatch Management</h1>
            <div class="user-id-display">
                <div class="connection-status" id="connectionStatus"></div>
                <div><i class="fas fa-user-circle"></i> <span id="userIdText">Loading user ID...</span></div>
                <div class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="dashboard-stats">
            <div class="dashboard-stat">
                <h3><i class="fas fa-file-alt"></i> Total Requests</h3>
                <p id="totalRequestsStat">0</p>
            </div>
            <div class="dashboard-stat">
                <h3><i class="fas fa-money-bill-wave"></i> Charged Requests</h3>
                <p id="chargedRequestsStat">0</p>
            </div>
            <div class="dashboard-stat">
                <h3><i class="fas fa-gift"></i> Uncharged Requests</h3>
                <p id="unchargedRequestsStat">0</p>
            </div>
            <div class="dashboard-stat">
                <h3><i class="fas fa-truck"></i> Pending Dispatch</h3>
                <p id="pendingDispatchStat">0</p>
            </div>
            <div class="dashboard-stat">
                <h3><i class="fas fa-check-circle"></i> Dispatched</h3>
                <p id="dispatchedStat">0</p>
            </div>
            <div class="dashboard-stat">
                <h3><i class="fas fa-boxes"></i> Total Items</h3>
                <p id="totalItemsStat">0</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action-btn" id="quickAddStockBtn">
                <i class="fas fa-plus-circle"></i> Add Stock
            </div>
            <div class="quick-action-btn" id="quickViewStockBtn">
                <i class="fas fa-clipboard-list"></i> View Stock
            </div>
            <div class="quick-action-btn" id="quickViewRequestsBtn">
                <i class="fas fa-list-alt"></i> View Requests
            </div>
            <div class="quick-action-btn" id="quickDispatchRequestsBtn">
                <i class="fas fa-truck"></i> Dispatch Requests
            </div>
            <div class="quick-action-btn" id="quickViewStatsBtn">
                <i class="fas fa-chart-pie"></i> View Stats
            </div>
        </div>

        <!-- Request Form Section -->
        <div class="collapsible-section">
            <div class="section-header" id="requestFormHeader">
                <div class="section-title">
                    <i class="fas fa-clipboard-list"></i> Request Form
                </div>
                <i class="fas fa-chevron-up section-toggle" id="requestFormToggle"></i>
            </div>
            <div class="section-content expanded" id="requestFormContent">
                <form id="uniformForm">
                    <!-- Employee Details -->
                    <div class="form-section">
                        <h3><i class="fas fa-user"></i> Employee Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="date"><i class="fas fa-calendar-alt"></i> Date:</label>
                                <input type="date" id="date" name="date" required>
                            </div>
                            <div class="form-group">
                                <label for="clockNo"><i class="fas fa-clock"></i> Clock No.:</label>
                                <input type="text" id="clockNo" name="clockNo" required>
                            </div>
                            <div class="form-group md:col-span-2">
                                <label for="names"><i class="fas fa-user"></i> Names:</label>
                                <input type="text" id="names" name="names" required>
                            </div>
                        </div>
                    </div>

                    <!-- Category Selection -->
                    <div class="form-section">
                        <h3><i class="fas fa-tags"></i> Category</h3>
                        <div class="form-group">
                            <select id="category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="Charged">Charged</option>
                                <option value="Uncharged">Uncharged</option>
                            </select>
                        </div>
                    </div>

                    <!-- Uniform Items -->
                    <div class="form-section">
                        <h3><i class="fas fa-box"></i> Uniform Items Requested</h3>
                        <div class="items-grid">
                            <!-- T-shirt -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-tshirt"></i> T-shirt (T)</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="tShirtQty">Quantity:</label>
                                        <input type="number" id="tShirtQty" name="tShirtQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="tShirtSize">Size:</label>
                                        <select id="tShirtSize" name="tShirtSize">
                                            <option value="">Select Size</option>
                                            <option value="XS">XS</option>
                                            <option value="S">S</option>
                                            <option value="M">M</option>
                                            <option value="L">L</option>
                                            <option value="XL">XL</option>
                                            <option value="XXL">XXL</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Golfer -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-tshirt"></i> Golfer (G)</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="golferQty">Quantity:</label>
                                        <input type="number" id="golferQty" name="golferQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="golferSize">Size:</label>
                                        <select id="golferSize" name="golferSize">
                                            <option value="">Select Size</option>
                                            <option value="XS">XS</option>
                                            <option value="S">S</option>
                                            <option value="M">M</option>
                                            <option value="L">L</option>
                                            <option value="XL">XL</option>
                                            <option value="XXL">XXL</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Jacket Royal Blue (JRB) -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-user-tie"></i> Jacket Royal Blue (JRB)</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="jrbQty">Quantity:</label>
                                        <input type="number" id="jrbQty" name="jrbQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="jrbSize">Size:</label>
                                        <select id="jrbSize" name="jrbSize">
                                            <option value="">Select Size</option>
                                            <option value="XS">XS</option>
                                            <option value="S">S</option>
                                            <option value="M">M</option>
                                            <option value="L">L</option>
                                            <option value="XL">XL</option>
                                            <option value="XXL">XXL</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Jacket Navy Blue (JNB) -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-user-tie"></i> Jacket Navy Blue (JNB)</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="jnbQty">Quantity:</label>
                                        <input type="number" id="jnbQty" name="jnbQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="jnbSize">Size:</label>
                                        <select id="jnbSize" name="jnbSize">
                                            <option value="">Select Size</option>
                                            <option value="XS">XS</option>
                                            <option value="S">S</option>
                                            <option value="M">M</option>
                                            <option value="L">L</option>
                                            <option value="XL">XL</option>
                                            <option value="XXL">XXL</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Beanie Royal Blue / Navy Blue (BRB BNB) -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-hat-winter"></i> Beanie (BRB/BNB)</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="beanieQty">Quantity:</label>
                                        <input type="number" id="beanieQty" name="beanieQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="beanieColor">Color:</label>
                                        <select id="beanieColor" name="beanieColor">
                                            <option value="">Select Color</option>
                                            <option value="Royal Blue">Royal Blue</option>
                                            <option value="Navy Blue">Navy Blue</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Skirt (S) -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-user"></i> Skirt (S)</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="skirtQty">Quantity:</label>
                                        <input type="number" id="skirtQty" name="skirtQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="skirtSize">Size:</label>
                                        <select id="skirtSize" name="skirtSize">
                                            <option value="">Select Size</option>
                                            <option value="28">28</option>
                                            <option value="30">30</option>
                                            <option value="32">32</option>
                                            <option value="34">34</option>
                                            <option value="36">36</option>
                                            <option value="38">38</option>
                                            <option value="40">40</option>
                                            <option value="42">42</option>
                                            <option value="44">44</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Abaya (A) -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-user"></i> Abaya (A)</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="abayaQty">Quantity:</label>
                                        <input type="number" id="abayaQty" name="abayaQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="abayaSize">Size:</label>
                                        <select id="abayaSize" name="abayaSize">
                                            <option value="">Select Size</option>
                                            <option value="XS">XS</option>
                                            <option value="S">S</option>
                                            <option value="M">M</option>
                                            <option value="L">L</option>
                                            <option value="XL">XL</option>
                                            <option value="XXL">XXL</option>
                                            <option value="No Size">No Size</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Caps -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-hat-cowboy"></i> Caps</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="capsQty">Quantity:</label>
                                        <input type="number" id="capsQty" name="capsQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="capsSize">Size:</label>
                                        <select id="capsSize" name="capsSize">
                                            <option value="">Select Size</option>
                                            <option value="No Size">No Size</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Shoes -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-shoe-prints"></i> Shoes</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="shoesQty">Quantity:</label>
                                        <input type="number" id="shoesQty" name="shoesQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="shoesSize">Size:</label>
                                        <select id="shoesSize" name="shoesSize">
                                            <option value="">Select Size</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                            <option value="7">7</option>
                                            <option value="8">8</option>
                                            <option value="9">9</option>
                                            <option value="10">10</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gloves -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-mitten"></i> Gloves</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="glovesQty">Quantity:</label>
                                        <input type="number" id="glovesQty" name="glovesQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="glovesType">Type:</label>
                                        <select id="glovesType" name="glovesType">
                                            <option value="">Select Type</option>
                                            <option value="Material">Material</option>
                                            <option value="Freezer">Freezer</option>
                                            <option value="Rubber">Rubber</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dust Coats -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-user-md"></i> Dust Coats</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="dustCoatsQty">Quantity:</label>
                                        <input type="number" id="dustCoatsQty" name="dustCoatsQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="dustCoatsSize">Size:</label>
                                        <select id="dustCoatsSize" name="dustCoatsSize">
                                            <option value="">Select Size</option>
                                            <option value="28">28</option>
                                            <option value="30">30</option>
                                            <option value="32">32</option>
                                            <option value="34">34</option>
                                            <option value="36">36</option>
                                            <option value="38">38</option>
                                            <option value="40">40</option>
                                            <option value="42">42</option>
                                            <option value="44">44</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Reflector -->
                            <div class="item-card">
                                <div class="item-card-header">
                                    <h4><i class="fas fa-vest"></i> Reflector</h4>
                                </div>
                                <div class="item-card-body">
                                    <div class="form-group">
                                        <label for="reflectorQty">Quantity:</label>
                                        <input type="number" id="reflectorQty" name="reflectorQty" min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="reflectorSize">Size:</label>
                                        <select id="reflectorSize" name="reflectorSize">
                                            <option value="">Select Size</option>
                                            <option value="No Size">No Size</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total and Signatures -->
                    <div class="form-section">
                        <h3><i class="fas fa-file-invoice-dollar"></i> Summary & Signatures</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="total"><i class="fas fa-calculator"></i> Total Items:</label>
                                <input type="text" id="total" name="total" readonly value="0">
                            </div>
                            <div class="form-group">
                                <label for="totalCost"><i class="fas fa-money-bill-wave"></i> Total Cost:</label>
                                <input type="text" id="totalCost" name="totalCost" readonly value="R 0.00">
                            </div>
                            <div class="form-group">
                                <label for="supervisorSign"><i class="fas fa-signature"></i> Supervisor Sign:</label>
                                <input type="text" id="supervisorSign" name="supervisorSign">
                            </div>
                            <div class="form-group">
                                <label for="employeeSign"><i class="fas fa-signature"></i> Employee Sign:</label>
                                <input type="text" id="employeeSign" name="employeeSign">
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="reset" class="reset-button"><i class="fas fa-redo"></i> Reset Form</button>
                        <button type="button" id="clearAllDataBtn" class="clear-button"><i class="fas fa-trash-alt"></i> Clear All Data</button>
                        <button type="button" id="toggleStatsBtn" class="toggle-stats-button"><i class="fas fa-chart-bar"></i> Show/Hide Stats</button>
                        <button type="submit" class="submit-button"><i class="fas fa-paper-plane"></i> Submit Request</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Stock Management Section -->
        <div class="collapsible-section">
            <div class="section-header" id="stockManagementHeader">
                <div class="section-title">
                    <i class="fas fa-warehouse"></i> Manage Stock
                </div>
                <i class="fas fa-chevron-up section-toggle" id="stockManagementToggle"></i>
            </div>
            <div class="section-content" id="stockManagementContent">
                <!-- Add Stock Section -->
                <div class="form-section">
                    <h3><i class="fas fa-plus-circle"></i> Add Stock</h3>
                    <div class="stock-input-group">
                        <div class="form-group mb-0">
                            <label for="addStockItemSelect"><i class="fas fa-box"></i> Select Item:</label>
                            <select id="addStockItemSelect">
                                <option value="">Select Item</option>
                                <option value="tShirt">T-shirt</option>
                                <option value="golfer">Golfer</option>
                                <option value="jrb">Jacket Royal Blue</option>
                                <option value="jnb">Jacket Navy Blue</option>
                                <option value="beanie">Beanie</option>
                                <option value="skirt">Skirt</option>
                                <option value="abaya">Abaya</option>
                                <option value="caps">Caps</option>
                                <option value="shoes">Shoes</option>
                                <option value="gloves">Gloves</option>
                                <option value="dustCoats">Dust Coats</option>
                                <option value="reflector">Reflector</option>
                            </select>
                        </div>
                        <div class="form-group mb-0">
                            <label for="addStockSizeColorSelect"><i class="fas fa-ruler"></i> Size/Color:</label>
                            <select id="addStockSizeColorSelect">
                                <option value="">Select Size/Color</option>
                                <option value="XS">XS</option>
                                <option value="S">S</option>
                                <option value="M">M</option>
                                <option value="L">L</option>
                                <option value="XL">XL</option>
                                <option value="XXL">XXL</option>
                                <option value="Royal Blue">Royal Blue</option>
                                <option value="Navy Blue">Navy Blue</option>
                                <option value="No Size">No Size</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="Material">Material</option>
                                <option value="Freezer">Freezer</option>
                                <option value="Rubber">Rubber</option>
                                <option value="28">28</option>
                                <option value="30">30</option>
                                <option value="32">32</option>
                                <option value="34">34</option>
                                <option value="36">36</option>
                                <option value="38">38</option>
                                <option value="40">40</option>
                                <option value="42">42</option>
                                <option value="44">44</option>
                            </select>
                        </div>
                        <div class="form-group mb-0">
                            <label for="addStockQuantityInput"><i class="fas fa-plus-circle"></i> Quantity to Add:</label>
                            <input type="number" id="addStockQuantityInput" min="1" value="1">
                        </div>
                        <div class="form-group mb-0">
                            <label for="addStockCostPrice"><i class="fas fa-tag"></i> Cost Price:</label>
                            <input type="number" id="addStockCostPrice" min="0" value="0.00" step="0.01">
                        </div>
                        <div class="form-group mb-0">
                            <label for="addStockAdjustedBy"><i class="fas fa-user"></i> Adjusted By:</label>
                            <input type="text" id="addStockAdjustedBy" placeholder="Name">
                        </div>
                        <button type="button" id="addStockBtn" class="add-stock-button"><i class="fas fa-plus"></i> Add Stock</button>
                    </div>
                </div>

                <!-- Manual Stock Adjustment Section -->
                <div class="form-section">
                    <h3><i class="fas fa-edit"></i> Set Stock Quantity</h3>
                    <div class="stock-input-group">
                        <div class="form-group mb-0">
                            <label for="setStockItemSelect"><i class="fas fa-box"></i> Select Item:</label>
                            <select id="setStockItemSelect">
                                <option value="">Select Item</option>
                                <option value="tShirt">T-shirt</option>
                                <option value="golfer">Golfer</option>
                                <option value="jrb">Jacket Royal Blue</option>
                                <option value="jnb">Jacket Navy Blue</option>
                                <option value="beanie">Beanie</option>
                                <option value="skirt">Skirt</option>
                                <option value="abaya">Abaya</option>
                                <option value="caps">Caps</option>
                                <option value="shoes">Shoes</option>
                                <option value="gloves">Gloves</option>
                                <option value="dustCoats">Dust Coats</option>
                                <option value="reflector">Reflector</option>
                            </select>
                        </div>
                        <div class="form-group mb-0">
                            <label for="setStockSizeColorSelect"><i class="fas fa-ruler"></i> Size/Color:</label>
                            <select id="setStockSizeColorSelect">
                                <option value="">Select Size/Color</option>
                                <option value="XS">XS</option>
                                <option value="S">S</option>
                                <option value="M">M</option>
                                <option value="L">L</option>
                                <option value="XL">XL</option>
                                <option value="XXL">XXL</option>
                                <option value="Royal Blue">Royal Blue</option>
                                <option value="Navy Blue">Navy Blue</option>
                                <option value="No Size">No Size</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="Material">Material</option>
                                <option value="Freezer">Freezer</option>
                                <option value="Rubber">Rubber</option>
                                <option value="28">28</option>
                                <option value="30">30</option>
                                <option value="32">32</option>
                                <option value="34">34</option>
                                <option value="36">36</option>
                                <option value="38">38</option>
                                <option value="40">40</option>
                                <option value="42">42</option>
                                <option value="44">44</option>
                            </select>
                        </div>
                        <div class="form-group mb-0">
                            <label for="setStockQuantityInput"><i class="fas fa-edit"></i> Set Stock To:</label>
                            <input type="number" id="setStockQuantityInput" min="0" value="0">
                        </div>
                        <div class="form-group mb-0">
                            <label for="setStockAdjustedBy"><i class="fas fa-user"></i> Adjusted By:</label>
                            <input type="text" id="setStockAdjustedBy" placeholder="Name">
                        </div>
                        <button type="button" id="setStockBtn" class="set-stock-button"><i class="fas fa-save"></i> Set Stock</button>
                    </div>
                </div>

                <!-- Clear All Stock -->
                <div class="form-section">
                    <h3><i class="fas fa-trash"></i> Clear All Stock</h3>
                    <div class="stock-buttons">
                        <div class="form-group mb-0">
                            <label for="clearStockAdjustedBy"><i class="fas fa-user"></i> Adjusted By:</label>
                            <input type="text" id="clearStockAdjustedBy" placeholder="Name">
                        </div>
                        <button type="button" id="clearAllStockBtn" class="clear-stock-button"><i class="fas fa-trash"></i> Clear All Stock</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dispatch Requests Section -->
        <div class="collapsible-section">
            <div class="section-header" id="dispatchHeader">
                <div class="section-title">
                    <i class="fas fa-truck"></i> Dispatch Uniforms
                </div>
                <i class="fas fa-chevron-up section-toggle" id="dispatchToggle"></i>
            </div>
            <div class="section-content" id="dispatchContent">
                <div class="request-list-categories-wrapper">
                    <div class="request-list-category pending-dispatch-category">
                        <h3><i class="fas fa-clock"></i> Pending Dispatch</h3>
                        <div id="pendingDispatchContainer">
                            <p class="text-gray-500 text-center" id="noPendingDispatchMessage">No pending dispatch requests.</p>
                        </div>
                    </div>

                    <div class="request-list-category dispatched-category">
                        <h3><i class="fas fa-check-circle"></i> Dispatched</h3>
                        <div id="dispatchedContainer">
                            <p class="text-gray-500 text-center" id="noDispatchedMessage">No uniforms have been dispatched yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Stock Levels Section -->
        <div class="collapsible-section">
            <div class="section-header" id="stockLevelsHeader">
                <div class="section-title">
                    <i class="fas fa-clipboard-list"></i> Current Stock Levels
                </div>
                <i class="fas fa-chevron-up section-toggle" id="stockLevelsToggle"></i>
            </div>
            <div class="section-content" id="stockLevelsContent">
                <div id="detailedStockDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Stock for each item will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Submitted Requests Section -->
        <div class="collapsible-section">
            <div class="section-header" id="requestsHeader">
                <div class="section-title">
                    <i class="fas fa-list-alt"></i> All Requests
                </div>
                <i class="fas fa-chevron-up section-toggle" id="requestsToggle"></i>
            </div>
            <div class="section-content" id="requestsContent">
                <div class="request-list-categories-wrapper">
                    <div class="request-list-category charged-category">
                        <h3><i class="fas fa-money-bill-wave"></i> Charged Requests</h3>
                        <div id="chargedRequestsContainer">
                            <p class="text-gray-500 text-center" id="noChargedRequestsMessage">No charged requests submitted yet.</p>
                        </div>
                    </div>

                    <div class="request-list-category uncharged-category">
                        <h3><i class="fas fa-gift"></i> Uncharged Requests</h3>
                        <div id="unchargedRequestsContainer">
                            <p class="text-gray-500 text-center" id="noUnchargedRequestsMessage">No uncharged requests submitted yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="collapsible-section">
            <div class="section-header" id="statsHeader">
                <div class="section-title">
                    <i class="fas fa-chart-pie"></i> Request Statistics
                </div>
                <i class="fas fa-chevron-up section-toggle" id="statsToggle"></i>
            </div>
            <div class="section-content" id="statsContent">
                <div class="stats-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="stat-card">
                        <h4><i class="fas fa-file-alt"></i> Total Requests</h4>
                        <p id="totalRequestsStat2">0</p>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-money-bill-wave"></i> Charged Requests</h4>
                        <p id="chargedRequestsStat2">0</p>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-gift"></i> Uncharged Requests</h4>
                        <p id="unchargedRequestsStat2">0</p>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-truck"></i> Pending Dispatch</h4>
                        <p id="pendingDispatchStat2">0</p>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-check-circle"></i> Dispatched</h4>
                        <p id="dispatchedStat2">0</p>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-boxes"></i> Total Items</h4>
                        <p id="totalItemsStat2">0</p>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-money-check-alt"></i> Total Charged Cost</h4>
                        <p id="totalChargedCostStat">R 0.00</p>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-hand-holding-usd"></i> Total Uncharged Cost</h4>
                        <p id="totalUnchargedCostStat">R 0.00</p>
                    </div>
                    
                    <!-- Item-wise breakdown -->
                    <div class="stat-card">
                        <h4><i class="fas fa-tshirt"></i> T-shirt</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="tShirtTotalStat">0</strong></p>
                            <p>Charged: <strong id="tShirtChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="tShirtUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="tShirtChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="tShirtUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="tShirtCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-tshirt"></i> Golfer</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="golferTotalStat">0</strong></p>
                            <p>Charged: <strong id="golferChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="golferUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="golferChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="golferUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="golferCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-user-tie"></i> Jacket Royal Blue</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="jrbTotalStat">0</strong></p>
                            <p>Charged: <strong id="jrbChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="jrbUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="jrbChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="jrbUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="jrbCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-user-tie"></i> Jacket Navy Blue</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="jnbTotalStat">0</strong></p>
                            <p>Charged: <strong id="jnbChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="jnbUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="jnbChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="jnbUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="jnbCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-hat-winter"></i> Beanie</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="beanieTotalStat">0</strong></p>
                            <p>Charged: <strong id="beanieChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="beanieUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="beanieChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="beanieUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="beanieCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-user"></i> Skirt</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="skirtTotalStat">0</strong></p>
                            <p>Charged: <strong id="skirtChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="skirtUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="skirtChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="skirtUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="skirtCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-user"></i> Abaya</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="abayaTotalStat">0</strong></p>
                            <p>Charged: <strong id="abayaChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="abayaUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="abayaChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="abayaUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="abayaCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-hat-cowboy"></i> Caps</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="capsTotalStat">0</strong></p>
                            <p>Charged: <strong id="capsChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="capsUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="capsChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="capsUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="capsCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-shoe-prints"></i> Shoes</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="shoesTotalStat">0</strong></p>
                            <p>Charged: <strong id="shoesChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="shoesUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="shoesChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="shoesUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="shoesCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-mitten"></i> Gloves</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="glovesTotalStat">0</strong></p>
                            <p>Charged: <strong id="glovesChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="glovesUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="glovesChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="glovesUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="glovesCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-user-md"></i> Dust Coats</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="dustCoatsTotalStat">0</strong></p>
                            <p>Charged: <strong id="dustCoatsChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="dustCoatsUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="dustCoatsChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="dustCoatsUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="dustCoatsCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-vest"></i> Reflector</h4>
                        <div class="item-stats">
                            <p>Total: <strong id="reflectorTotalStat">0</strong></p>
                            <p>Charged: <strong id="reflectorChargedStat">0</strong></p>
                            <p>Uncharged: <strong id="reflectorUnchargedStat">0</strong></p>
                            <p>Cost (Charged): <strong id="reflectorChargedCostStat">R 0.00</strong></p>
                            <p>Cost (Uncharged): <strong id="reflectorUnchargedCostStat">R 0.00</strong></p>
                            <p>Current Stock: <strong id="reflectorCurrentStockStat">0</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock History Section -->
        <div class="collapsible-section">
            <div class="section-header" id="stockHistoryHeader">
                <div class="section-title">
                    <i class="fas fa-history"></i> Stock Adjustment History
                </div>
                <i class="fas fa-chevron-up section-toggle" id="stockHistoryToggle"></i>
            </div>
            <div class="section-content" id="stockHistoryContent">
                <div id="stockHistoryContainer">
                    <p class="text-gray-500 text-center" id="noStockHistoryMessage">No stock adjustments recorded yet.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box for alerts -->
    <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <div class="confirm-buttons" id="messageBoxButtons">
            <button id="messageBoxOkBtn">OK</button>
        </div>
    </div>

    <!-- Modal Backdrop -->
    <div class="modal-backdrop" id="modalBackdrop"></div>

    <!-- Signature Capture Modal -->
    <div id="signatureModal">
        <h3><i class="fas fa-signature"></i> Employee Signature for Uniform Receipt</h3>
        <div id="dispatchRequestInfo" style="margin: 15px 0;">
            <!-- Request details will be displayed here -->
        </div>
        
        <div class="signature-pad-container">
            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-primary);">
                <i class="fas fa-pen"></i> Please sign below to acknowledge receipt of uniform items:
            </label>
            <!-- The Canvas -->
            <canvas id="signaturePad" class="signature-box"></canvas>
            
            <div class="signature-actions">
                <button type="button" id="clearSignatureBtn" class="reset-button"><i class="fas fa-eraser"></i> Clear Signature</button>
                <button type="button" id="cancelSignatureBtn" class="clear-button"><i class="fas fa-times"></i> Cancel</button>
                <button type="button" id="saveSignatureBtn" class="dispatch-button"><i class="fas fa-check"></i> Confirm & Dispatch</button>
            </div>
        </div>
        
        <div style="margin-top: 15px; color: var(--text-secondary); font-size: 0.85rem;">
            <p><i class="fas fa-info-circle"></i> <strong>Instructions:</strong> Sign using your mouse or touch screen. Click "Clear Signature" to start over.</p>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, getDocs, deleteDoc, doc, writeBatch, serverTimestamp, runTransaction, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Global variables for Canvas environment
        let appId = 'default-app-id';
        if (typeof __app_id !== 'undefined') {
            appId = __app_id;
        }

        let initialAuthToken = null;
        if (typeof __initial_auth_token !== 'undefined') {
            initialAuthToken = __initial_auth_token;
        }

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;
        let currentStock = {};
        let retryCount = 0;
        const maxRetries = 3;
        let signaturePad = null;
        let currentRequestForDispatch = null;

        // Define possible sizes and colors
        const sizes = ["XS", "S", "M", "L", "XL", "XXL"];
        const skirtSizes = ["28", "30", "32", "34", "36", "38", "40", "42", "44"];
        const shoeSizes = ["5", "6", "7", "8", "9", "10"];
        const gloveTypes = ["Material", "Freezer", "Rubber"];
        const dustCoatSizes = ["28", "30", "32", "34", "36", "38", "40", "42", "44"];
        const colors = ["Royal Blue", "Navy Blue"];
        const noSizeOption = ["No Size"];

        // Define initial stock levels and their default cost prices
        const initialStockLevels = {
            tShirt: { XS: 10, S: 20, M: 30, L: 20, XL: 10, XXL: 5, costPrice: 75.00 },
            golfer: { XS: 8, S: 15, M: 25, L: 18, XL: 10, XXL: 4, costPrice: 120.00 },
            jrb: { XS: 5, S: 10, M: 15, L: 10, XL: 6, XXL: 4, costPrice: 250.00 },
            jnb: { XS: 5, S: 10, M: 15, L: 10, XL: 6, XXL: 4, costPrice: 250.00 },
            beanie: { 'Royal Blue': 75, 'Navy Blue': 75, costPrice: 50.00 },
            skirt: { '28': 5, '30': 8, '32': 10, '34': 12, '36': 15, '38': 12, '40': 10, '42': 8, '44': 5, costPrice: 180.00 },
            abaya: { XS: 4, S: 8, M: 12, L: 8, XL: 5, XXL: 3, 'No Size': 10, costPrice: 300.00 },
            caps: { 'No Size': 50, costPrice: 40.00 },
            shoes: { '5': 5, '6': 8, '7': 10, '8': 12, '9': 10, '10': 8, costPrice: 200.00 },
            gloves: { 'Material': 50, 'Freezer': 30, 'Rubber': 40, costPrice: 25.00 },
            dustCoats: { '28': 5, '30': 8, '32': 10, '34': 12, '36': 15, '38': 12, '40': 10, '42': 8, '44': 5, costPrice: 150.00 },
            reflector: { 'No Size': 30, costPrice: 80.00 }
        };

        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Collapsible sections management
        function initCollapsibleSections() {
            const sections = [
                { header: 'requestFormHeader', content: 'requestFormContent', toggle: 'requestFormToggle', defaultExpanded: true },
                { header: 'stockManagementHeader', content: 'stockManagementContent', toggle: 'stockManagementToggle', defaultExpanded: false },
                { header: 'dispatchHeader', content: 'dispatchContent', toggle: 'dispatchToggle', defaultExpanded: false },
                { header: 'stockLevelsHeader', content: 'stockLevelsContent', toggle: 'stockLevelsToggle', defaultExpanded: false },
                { header: 'requestsHeader', content: 'requestsContent', toggle: 'requestsToggle', defaultExpanded: false },
                { header: 'statsHeader', content: 'statsContent', toggle: 'statsToggle', defaultExpanded: false },
                { header: 'stockHistoryHeader', content: 'stockHistoryContent', toggle: 'stockHistoryToggle', defaultExpanded: false }
            ];

            sections.forEach(section => {
                const header = document.getElementById(section.header);
                const content = document.getElementById(section.content);
                const toggle = document.getElementById(section.toggle);

                // Set initial state
                if (section.defaultExpanded) {
                    content.style.maxHeight = content.scrollHeight + "px";
                    content.classList.add('expanded');
                } else {
                    toggle.classList.add('collapsed');
                }

                // Add click event
                header.addEventListener('click', () => {
                    if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                        // Collapse
                        content.style.maxHeight = '0px';
                        content.classList.remove('expanded');
                        toggle.classList.add('collapsed');
                    } else {
                        // Expand
                        content.style.maxHeight = content.scrollHeight + "px";
                        content.classList.add('expanded');
                        toggle.classList.remove('collapsed');
                    }
                });
            });
        }

        // Quick actions functionality
        function initQuickActions() {
            document.getElementById('quickAddStockBtn').addEventListener('click', () => {
                const stockManagementHeader = document.getElementById('stockManagementHeader');
                const stockManagementContent = document.getElementById('stockManagementContent');
                const stockManagementToggle = document.getElementById('stockManagementToggle');
                
                // Expand stock management section
                stockManagementContent.style.maxHeight = stockManagementContent.scrollHeight + "px";
                stockManagementContent.classList.add('expanded');
                stockManagementToggle.classList.remove('collapsed');
                
                // Scroll to the section
                stockManagementHeader.scrollIntoView({ behavior: 'smooth' });
            });

            document.getElementById('quickViewStockBtn').addEventListener('click', () => {
                const stockLevelsHeader = document.getElementById('stockLevelsHeader');
                const stockLevelsContent = document.getElementById('stockLevelsContent');
                const stockLevelsToggle = document.getElementById('stockLevelsToggle');
                
                // Expand stock levels section
                stockLevelsContent.style.maxHeight = stockLevelsContent.scrollHeight + "px";
                stockLevelsContent.classList.add('expanded');
                stockLevelsToggle.classList.remove('collapsed');
                
                // Scroll to the section
                stockLevelsHeader.scrollIntoView({ behavior: 'smooth' });
            });

            document.getElementById('quickViewRequestsBtn').addEventListener('click', () => {
                const requestsHeader = document.getElementById('requestsHeader');
                const requestsContent = document.getElementById('requestsContent');
                const requestsToggle = document.getElementById('requestsToggle');
                
                // Expand requests section
                requestsContent.style.maxHeight = requestsContent.scrollHeight + "px";
                requestsContent.classList.add('expanded');
                requestsToggle.classList.remove('collapsed');
                
                // Scroll to the section
                requestsHeader.scrollIntoView({ behavior: 'smooth' });
            });

            document.getElementById('quickDispatchRequestsBtn').addEventListener('click', () => {
                const dispatchHeader = document.getElementById('dispatchHeader');
                const dispatchContent = document.getElementById('dispatchContent');
                const dispatchToggle = document.getElementById('dispatchToggle');
                
                // Expand dispatch section
                dispatchContent.style.maxHeight = dispatchContent.scrollHeight + "px";
                dispatchContent.classList.add('expanded');
                dispatchToggle.classList.remove('collapsed');
                
                // Scroll to the section
                dispatchHeader.scrollIntoView({ behavior: 'smooth' });
            });

            document.getElementById('quickViewStatsBtn').addEventListener('click', () => {
                const statsHeader = document.getElementById('statsHeader');
                const statsContent = document.getElementById('statsContent');
                const statsToggle = document.getElementById('statsToggle');
                
                // Expand stats section
                statsContent.style.maxHeight = statsContent.scrollHeight + "px";
                statsContent.classList.add('expanded');
                statsToggle.classList.remove('collapsed');
                
                // Scroll to the section
                statsHeader.scrollIntoView({ behavior: 'smooth' });
            });
        }

        // Function to update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.classList.add('connected');
            } else {
                statusElement.classList.remove('connected');
            }
        }

        // Function to format currency
        function formatCurrency(amount) {
            return `R ${amount.toFixed(2)}`;
        }

        // Function to show custom message box
        function showMessageBox(message, type = 'alert', onConfirm = null) {
            const messageBox = document.getElementById('messageBox');
            document.getElementById('messageText').innerText = message;
            const messageBoxButtons = document.getElementById('messageBoxButtons');
            messageBoxButtons.innerHTML = '';

            if (type === 'confirm') {
                const yesBtn = document.createElement('button');
                yesBtn.innerText = 'Yes';
                yesBtn.className = 'submit-button';
                yesBtn.onclick = () => {
                    messageBox.classList.remove('show');
                    setTimeout(() => messageBox.style.display = 'none', 300);
                    if (onConfirm) onConfirm(true);
                };
                messageBoxButtons.appendChild(yesBtn);

                const noBtn = document.createElement('button');
                noBtn.innerText = 'No';
                noBtn.className = 'reset-button';
                noBtn.onclick = () => {
                    messageBox.classList.remove('show');
                    setTimeout(() => messageBox.style.display = 'none', 300);
                    if (onConfirm) onConfirm(false);
                };
                messageBoxButtons.appendChild(noBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.innerText = 'OK';
                okBtn.className = 'submit-button';
                okBtn.onclick = () => {
                    messageBox.classList.remove('show');
                    setTimeout(() => messageBox.style.display = 'none', 300);
                    if (onConfirm) onConfirm(true);
                };
                messageBoxButtons.appendChild(okBtn);
            }
            messageBox.style.display = 'block';
            setTimeout(() => messageBox.classList.add('show'), 10);
        }

        // --- SIGNATURE PAD FIXES ---
        
        // Prevent default touch behavior specifically for the canvas
        function preventDefaultTouch(e) {
            if (e.target.id === 'signaturePad') {
                e.preventDefault();
            }
        }

        // Function to resize canvas to match display size for high DPI
        function resizeCanvas(canvas) {
            const ratio =  Math.max(window.devicePixelRatio || 1, 1);
            // Only set if dimensions are different to avoid clearing content unnecessarily
            if (canvas.width !== canvas.offsetWidth * ratio || canvas.height !== canvas.offsetHeight * ratio) {
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                return true; // Resized
            }
            return false; // Not resized
        }

        // Function to initialize signature pad
        function initializeSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            
            // Ensure canvas has strict touch-action set via JS (fallback)
            canvas.style.touchAction = 'none';
            canvas.style.userSelect = 'none';
            canvas.style.webkitUserSelect = 'none';
            
            resizeCanvas(canvas);

            // Create signature pad with proper configuration
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'black',
                minWidth: 1, // Slightly wider for mobile touch
                maxWidth: 3.5,
                throttle: 16, // Limit updates for performance
                minDistance: 2 // Require slight movement
            });

            console.log("Signature pad initialized successfully");
        }

        // Function to show signature modal
        function showSignatureModal(request) {
            currentRequestForDispatch = request;
            
            // Display request details in modal
            const dispatchInfoDiv = document.getElementById('dispatchRequestInfo');
            dispatchInfoDiv.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border-left: 4px solid var(--info);">
                    <p style="margin-bottom: 8px;"><strong><i class="fas fa-user"></i> Employee:</strong> ${request.names}</p>
                    <p style="margin-bottom: 8px;"><strong><i class="fas fa-clock"></i> Clock No:</strong> ${request.clockNo}</p>
                    <p style="margin-bottom: 8px;"><strong><i class="fas fa-calendar-alt"></i> Request Date:</strong> ${request.date}</p>
                    <p style="margin-bottom: 8px;"><strong><i class="fas fa-tags"></i> Category:</strong> ${request.category}</p>
                    <p style="margin-bottom: 8px;"><strong><i class="fas fa-boxes"></i> Total Items:</strong> ${request.totalItems}</p>
                    <p><strong><i class="fas fa-money-bill-wave"></i> Total Cost:</strong> ${formatCurrency(request.totalCost || 0)}</p>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffc107;">
                    <p style="margin: 0; font-weight: 600; color: #856404;">
                        <i class="fas fa-exclamation-triangle"></i> Please sign to confirm receipt of the above uniform items.
                    </p>
                </div>
            `;
            
            // Show backdrop
            document.getElementById('modalBackdrop').classList.add('show');
            
            // Show modal
            const signatureModal = document.getElementById('signatureModal');
            signatureModal.style.display = 'block';
            
            // FIX: Delay initialization slightly to allow display:block to render so dimensions are correct
            // We also wait for the CSS transition (0.3s defined in CSS)
            setTimeout(() => {
                signatureModal.classList.add('show');
                
                // Now that it's visible, initialize or resize the pad
                if (!signaturePad) {
                    initializeSignaturePad();
                } else {
                    // Clear any existing signature
                    signaturePad.clear();
                    // Resize canvas to current visual size
                    const canvas = document.getElementById('signaturePad');
                    resizeCanvas(canvas);
                    // The resize clears the canvas context, so we might need to re-apply scaling if the library doesn't handle it.
                    // SignaturePad creates its own internal handling, but usually requires re-init on drastic resize
                    // or handling the resize callback. Here we just ensure it fits.
                }
            }, 50); // Short delay for browser paint
        }

        // Function to hide signature modal
        function hideSignatureModal() {
            const signatureModal = document.getElementById('signatureModal');
            signatureModal.classList.remove('show');
            
            // Hide backdrop
            document.getElementById('modalBackdrop').classList.remove('show');
            
            setTimeout(() => {
                signatureModal.style.display = 'none';
                currentRequestForDispatch = null;
                
                // Clear signature
                if (signaturePad) {
                    signaturePad.clear();
                }
            }, 300);
        }

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCm159uTnKBY-3Fu6bSK2dqWUJd1HJFvWg",
            authDomain: "hr-reporting-71160.firebaseapp.com",
            projectId: "hr-reporting-71160",
            storageBucket: "hr-reporting-71160.firebasestorage.app",
            messagingSenderId: "733382247099",
            appId: "1:733382247099:web:ee59c578e0c39b4ace9f9e",
            measurementId: "G-TCZWPNGGGV"
        };

        // Function to initialize Firebase with retry mechanism
        async function initializeFirebaseWithRetry() {
            if (retryCount >= maxRetries) {
                console.error("Max retry attempts reached for Firebase initialization.");
                return;
            }

            retryCount++;
            console.log(`Firebase initialization attempt ${retryCount} of ${maxRetries}`);

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase app and services initialized successfully.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('userIdText').innerHTML = `<i class="fas fa-user-circle"></i> Your User ID: ${currentUserId}`;
                        console.log("User signed in:", currentUserId);
                        isAuthReady = true;
                        updateConnectionStatus(true);
                        
                        startAllListeners();
                    } else {
                        if (!auth.currentUser) {
                            try {
                                document.getElementById('userIdText').innerHTML = `<i class="fas fa-spinner fa-spin"></i> Authenticating...`;
                                if (initialAuthToken) {
                                    console.log("Attempting to sign in with custom token...");
                                    await signInWithCustomToken(auth, initialAuthToken);
                                    console.log("Signed in with custom token.");
                                } else {
                                    console.log("No custom token provided, signing in anonymously...");
                                    await signInAnonymously(auth);
                                    console.log("Signed in anonymously.");
                                }
                            } catch (authError) {
                                console.error("Error during authentication attempt:", authError);
                                updateConnectionStatus(false);
                                let errorMessage = "Authentication failed. Data persistence may not work.";

                                if (authError.code === 'auth/custom-token-mismatch') {
                                    console.warn("Custom token mismatch. Attempting anonymous sign-in as fallback.");
                                    try {
                                        await signInAnonymously(auth);
                                        console.log("Successfully signed in anonymously after custom token mismatch.");
                                        return;
                                    } catch (anonError) {
                                        console.error("Failed to sign in anonymously after custom token mismatch:", anonError);
                                        errorMessage += "\nFailed to sign in anonymously as well.";
                                    }
                                } else if (authError.code === 'auth/invalid-api-key') {
                                    errorMessage = "Authentication failed: Invalid API key.";
                                } else if (authError.code === 'auth/network-request-failed') {
                                    errorMessage = "Network error during authentication. Retrying...";
                                    setTimeout(() => initializeFirebaseWithRetry(), 2000);
                                    return;
                                } else {
                                    errorMessage += `\nError code: ${authError.code}. Details: ${authError.message}`;
                                }
                                document.getElementById('userIdText').innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMessage}`;
                                isAuthReady = false;
                            }
                        } else {
                            isAuthReady = false;
                            document.getElementById('userIdText').innerHTML = `<i class="fas fa-exclamation-circle"></i> Not authenticated`;
                            updateConnectionStatus(false);
                        }
                    }
                });
            } catch (error) {
                console.error("Error during Firebase app or service initialization:", error);
                updateConnectionStatus(false);
                document.getElementById('userIdText').innerHTML = `<i class="fas fa-exclamation-triangle"></i> Initialization failed`;
                isAuthReady = false;
                
                setTimeout(() => initializeFirebaseWithRetry(), 2000);
            }
        }

        // Function to start all listeners
        function startAllListeners() {
            try {
                console.log("Starting Firebase listeners...");
                listenForRequests();
                listenForStock();
                listenForStockHistory();
                console.log("All Firebase listeners started successfully");
            } catch (error) {
                console.error("Error starting listeners:", error);
                showMessageBox("Error starting data listeners. Please refresh page.");
            }
        }

        // Get DOM elements
        const uniformForm = document.getElementById('uniformForm');
        const quantityInputs = document.querySelectorAll('input[type="number"][id$="Qty"]');
        const totalItemsInput = document.getElementById('total');
        const totalCostInput = document.getElementById('totalCost');
        const pendingDispatchContainer = document.getElementById('pendingDispatchContainer');
        const dispatchedContainer = document.getElementById('dispatchedContainer');
        const chargedRequestsContainer = document.getElementById('chargedRequestsContainer');
        const unchargedRequestsContainer = document.getElementById('unchargedRequestsContainer');
        const noPendingDispatchMessage = document.getElementById('noPendingDispatchMessage');
        const noDispatchedMessage = document.getElementById('noDispatchedMessage');
        const noChargedRequestsMessage = document.getElementById('noChargedRequestsMessage');
        const noUnchargedRequestsMessage = document.getElementById('noUnchargedRequestsMessage');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');
        const toggleStatsBtn = document.getElementById('toggleStatsBtn');
        const detailedStockDisplay = document.getElementById('detailedStockDisplay');
        const stockHistoryContainer = document.getElementById('stockHistoryContainer');
        const noStockHistoryMessage = document.getElementById('noStockHistoryMessage');

        // Stock Management Elements
        const addStockItemSelect = document.getElementById('addStockItemSelect');
        const addStockSizeColorSelect = document.getElementById('addStockSizeColorSelect');
        const addStockQuantityInput = document.getElementById('addStockQuantityInput');
        const addStockCostPrice = document.getElementById('addStockCostPrice');
        const addStockAdjustedBy = document.getElementById('addStockAdjustedBy');
        const addStockBtn = document.getElementById('addStockBtn');

        const setStockItemSelect = document.getElementById('setStockItemSelect');
        const setStockSizeColorSelect = document.getElementById('setStockSizeColorSelect');
        const setStockQuantityInput = document.getElementById('setStockQuantityInput');
        const setStockAdjustedBy = document.getElementById('setStockAdjustedBy');
        const setStockBtn = document.getElementById('setStockBtn');

        const clearStockAdjustedBy = document.getElementById('clearStockAdjustedBy');
        const clearAllStockBtn = document.getElementById('clearAllStockBtn');

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');

        // Map item IDs to their corresponding quantity, size/color, and stock display input IDs
        const itemMap = {
            tShirt: { name: 'T-shirt', qtyId: 'tShirtQty', sizeId: 'tShirtSize', currentStockStatId: 'tShirtCurrentStockStat' },
            golfer: { name: 'Golfer', qtyId: 'golferQty', sizeId: 'golferSize', currentStockStatId: 'golferCurrentStockStat' },
            jrb: { name: 'Jacket Royal Blue', qtyId: 'jrbQty', sizeId: 'jrbSize', currentStockStatId: 'jrbCurrentStockStat' },
            jnb: { name: 'Jacket Navy Blue', qtyId: 'jnbQty', sizeId: 'jnbSize', currentStockStatId: 'jnbCurrentStockStat' },
            beanie: { name: 'Beanie', qtyId: 'beanieQty', colorId: 'beanieColor', currentStockStatId: 'beanieCurrentStockStat' },
            skirt: { name: 'Skirt', qtyId: 'skirtQty', sizeId: 'skirtSize', currentStockStatId: 'skirtCurrentStockStat' },
            abaya: { name: 'Abaya', qtyId: 'abayaQty', sizeId: 'abayaSize', currentStockStatId: 'abayaCurrentStockStat' },
            caps: { name: 'Caps', qtyId: 'capsQty', sizeId: 'capsSize', currentStockStatId: 'capsCurrentStockStat' },
            shoes: { name: 'Shoes', qtyId: 'shoesQty', sizeId: 'shoesSize', currentStockStatId: 'shoesCurrentStockStat' },
            gloves: { name: 'Gloves', qtyId: 'glovesQty', typeId: 'glovesType', currentStockStatId: 'glovesCurrentStockStat' },
            dustCoats: { name: 'Dust Coats', qtyId: 'dustCoatsQty', sizeId: 'dustCoatsSize', currentStockStatId: 'dustCoatsCurrentStockStat' },
            reflector: { name: 'Reflector', qtyId: 'reflectorQty', sizeId: 'reflectorSize', currentStockStatId: 'reflectorCurrentStockStat' }
        };

        // Function to update stock display in form and stats section
        function renderStockDisplay() {
            detailedStockDisplay.innerHTML = '';

            for (const itemType in itemMap) {
                const itemDisplayName = itemMap[itemType].name;
                const itemStockData = currentStock[itemType] || {};

                const itemCard = document.createElement('div');
                itemCard.className = 'stock-item-card';
                itemCard.innerHTML = `<h4 class="font-semibold text-gray-700 mb-3"><i class="fas fa-box"></i> ${itemDisplayName}</h4>`;

                const ul = document.createElement('ul');
                ul.className = 'list-none p-0 m-0';

                let relevantOptions = [];
                if (itemType === 'beanie') {
                    relevantOptions = colors;
                } else if (itemType === 'skirt' || itemType === 'dustCoats') {
                    relevantOptions = skirtSizes;
                } else if (itemType === 'shoes') {
                    relevantOptions = shoeSizes;
                } else if (itemType === 'gloves') {
                    relevantOptions = gloveTypes;
                } else if (itemType === 'caps' || itemType === 'reflector') {
                    relevantOptions = noSizeOption;
                } else if (itemType === 'abaya') {
                    relevantOptions = [...sizes, ...noSizeOption];
                } else {
                    relevantOptions = sizes;
                }

                relevantOptions.forEach(option => {
                    const stockValue = itemStockData[option] !== undefined ? itemStockData[option] : 0;
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center py-1 border-b border-gray-100 last:border-b-0';
                    let stockColor = '#4a5568';
                    if (stockValue < 5) {
                        stockColor = '#e53e3e';
                    } else if (stockValue < 10) {
                        stockColor = '#dd6b20';
                    }
                    li.innerHTML = `<span class="text-gray-600">${option}:</span> <span style="color: ${stockColor}; font-weight: 600;">${stockValue}</span>`;
                    ul.appendChild(li);
                });
                itemCard.appendChild(ul);
                detailedStockDisplay.appendChild(itemCard);
            }
        }

        // Function to record stock adjustment in history
        async function recordStockAdjustment(itemType, quantityChange, newQuantity, adjustedBy, adjustmentType, costPrice = null, sizeOrColor = null) {
            if (!isAuthReady || !currentUserId) {
                console.warn("Firestore not ready for stock history recording.");
                return;
            }

            const stockHistoryCollectionRef = collection(db, `artifacts/${appId}/public/data/stockAdjustments`);
            const record = {
                item: itemMap[itemType] ? itemMap[itemType].name : itemType,
                quantityChange: quantityChange,
                newQuantity: newQuantity,
                adjustedBy: adjustedBy,
                adjustmentType: adjustmentType,
                timestamp: serverTimestamp(),
                userId: currentUserId
            };

            if (costPrice !== null) {
                record.costPrice = costPrice;
            }
            if (sizeOrColor !== null && sizeOrColor !== "") {
                record.sizeOrColor = sizeOrColor;
            }

            try {
                await addDoc(stockHistoryCollectionRef, record);
                console.log("Stock adjustment recorded successfully.");
            } catch (e) {
                console.error("Error recording stock adjustment:", e);
            }
        }

        // Listen for real-time updates to stock levels from Firestore
        function listenForStock() {
            if (!isAuthReady) {
                console.warn("Firestore not ready for stock listener.");
                return;
            }

            console.log("Setting up stock listener...");
            const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');

            onSnapshot(stockDocRef, async (docSnapshot) => {
                if (docSnapshot.exists()) {
                    currentStock = docSnapshot.data();
                    console.log("Current stock updated from Firestore:", currentStock);
                    updateConnectionStatus(true);
                } else {
                    console.log("Stock document not found, initializing with initial levels.");
                    currentStock = JSON.parse(JSON.stringify(initialStockLevels));
                    try {
                        await setDoc(stockDocRef, {
                            ...initialStockLevels,
                            lastAdjustedBy: "System Initialization",
                            lastAdjustedAt: serverTimestamp()
                        });
                        console.log("Initial stock levels set in Firestore.");
                    } catch (e) {
                        console.error("Error setting initial stock levels:", e);
                    }
                }
                renderStockDisplay();
                updateTotalStockStats();
            }, (error) => {
                console.error("Error listening to stock:", error);
                updateConnectionStatus(false);
                if (error.code === 'permission-denied') {
                    showMessageBox("Permission denied accessing stock data. Please check Firebase Security Rules.");
                } else if (error.code === 'unavailable') {
                    showMessageBox("Firestore service unavailable. Please check your connection.");
                } else {
                    showMessageBox("Error loading stock data: " + error.message);
                }
            });
        }

        // Function to update total stock for each item in the stats section
        function updateTotalStockStats() {
            for (const itemType in itemMap) {
                const totalStockStatElement = document.getElementById(itemMap[itemType].currentStockStatId);
                if (totalStockStatElement) {
                    let totalItemStock = 0;
                    const itemStockData = currentStock[itemType] || {};
                    
                    let relevantOptions = [];
                    if (itemType === 'beanie') {
                        relevantOptions = colors;
                    } else if (itemType === 'skirt' || itemType === 'dustCoats') {
                        relevantOptions = skirtSizes;
                    } else if (itemType === 'shoes') {
                        relevantOptions = shoeSizes;
                    } else if (itemType === 'gloves') {
                        relevantOptions = gloveTypes;
                    } else if (itemType === 'caps' || itemType === 'reflector') {
                        relevantOptions = noSizeOption;
                    } else if (itemType === 'abaya') {
                        relevantOptions = [...sizes, ...noSizeOption];
                    } else {
                        relevantOptions = sizes;
                    }
                    
                    relevantOptions.forEach(option => {
                        totalItemStock += itemStockData[option] || 0;
                    });
                    totalStockStatElement.innerText = totalItemStock;
                }
            }
        }

        // Function to create HTML for a stock history item
        function createStockHistoryItemHtml(historyItem) {
            const historyDiv = document.createElement('div');
            historyDiv.className = 'stock-history-item';
            historyDiv.innerHTML = `
                <p><strong><i class="fas fa-box"></i> Item:</strong> ${historyItem.item}</p>
                <p><strong><i class="fas fa-exchange-alt"></i> Change:</strong> ${historyItem.quantityChange > 0 ? '+' : ''}${historyItem.quantityChange}</p>
                <p><strong><i class="fas fa-warehouse"></i> New Stock:</strong> ${historyItem.newQuantity}</p>
                ${historyItem.sizeOrColor ? `<p><strong><i class="fas fa-ruler"></i> Size/Color:</strong> ${historyItem.sizeOrColor}</p>` : ''}
                ${historyItem.costPrice !== undefined && historyItem.costPrice !== null ? `<p><strong><i class="fas fa-tag"></i> Cost Price:</strong> ${formatCurrency(historyItem.costPrice)}</p>` : ''}
                <p><strong><i class="fas fa-user"></i> Adjusted By:</strong> ${historyItem.adjustedBy || 'N/A'}</p>
                <p><strong><i class="fas fa-cog"></i> Type:</strong> ${historyItem.adjustmentType || 'N/A'}</p>
                <p class="timestamp"><strong><i class="fas fa-clock"></i> When:</strong> ${historyItem.timestamp ? new Date(historyItem.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
            `;
            return historyDiv;
        }

        // Listen for real-time updates to stock adjustment history
        function listenForStockHistory() {
            if (!isAuthReady) {
                console.warn("Firestore not ready for stock history listener.");
                return;
            }

            console.log("Setting up stock history listener...");
            const stockHistoryCollectionRef = collection(db, `artifacts/${appId}/public/data/stockAdjustments`);
            const q = query(stockHistoryCollectionRef);

            onSnapshot(q, (snapshot) => {
                const historyItems = [];
                snapshot.forEach((doc) => {
                    historyItems.push({ id: doc.id, ...doc.data() });
                });
                historyItems.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                stockHistoryContainer.innerHTML = '';
                if (historyItems.length === 0) {
                    noStockHistoryMessage.style.display = 'block';
                } else {
                    noStockHistoryMessage.style.display = 'none';
                    historyItems.forEach(item => {
                        stockHistoryContainer.appendChild(createStockHistoryItemHtml(item));
                    });
                }
                console.log("Stock history updated from Firestore.");
            }, (error) => {
                console.error("Error listening to stock history:", error);
                updateConnectionStatus(false);
                if (error.code === 'permission-denied') {
                    showMessageBox("Permission denied accessing stock history. Please check Firebase Security Rules.");
                }
            });
        }

        // Function to calculate total items and total cost
        function calculateTotals() {
            let totalItems = 0;
            let totalCalculatedCost = 0;

            for (const itemType in itemMap) {
                const qtyInput = document.getElementById(itemMap[itemType].qtyId);
                const quantity = parseInt(qtyInput.value) || 0;

                totalItems += quantity;

                const itemPrice = currentStock[itemType]?.costPrice !== undefined ? currentStock[itemType].costPrice : 0;
                totalCalculatedCost += quantity * itemPrice;
            }

            totalItemsInput.value = totalItems;
            totalCostInput.value = formatCurrency(totalCalculatedCost);
        }

        // Add event listeners to quantity inputs to recalculate totals on change
        quantityInputs.forEach(input => {
            input.addEventListener('input', calculateTotals);
        });

        // Set current date as default
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
            calculateTotals();
            
            // Initialize theme and collapsible sections
            initTheme();
            initCollapsibleSections();
            initQuickActions();
            
            // Initialize Firebase
            initializeFirebaseWithRetry();
            
            // FIX: Add global touch prevention specifically for the canvas
            // This is crucial for Android Chrome which sometimes ignores CSS-only touch-action
            const canvas = document.getElementById('signaturePad');
            canvas.addEventListener('touchstart', preventDefaultTouch, { passive: false });
            canvas.addEventListener('touchmove', preventDefaultTouch, { passive: false });
            canvas.addEventListener('touchend', preventDefaultTouch, { passive: false });
        });

        // Theme toggle event listener
        themeToggle.addEventListener('click', toggleTheme);

        // Function to create a request item HTML element with dispatch functionality and signature display
        function createRequestItemHtml(request) {
            const requestDiv = document.createElement('div');
            
            // Determine status class and badge
            let statusClass = '';
            let statusBadge = '';
            let dispatchActions = '';
            let signatureDisplay = '';
            
            if (request.dispatchStatus === 'dispatched') {
                statusClass = 'dispatched';
                statusBadge = '<span class="status-badge status-dispatched"><i class="fas fa-check-circle"></i> Dispatched</span>';
                
                // Show dispatch info if available
                let dispatchInfo = '';
                if (request.dispatchDate) {
                    const dispatchDate = request.dispatchDate.toDate ? request.dispatchDate.toDate() : new Date(request.dispatchDate);
                    dispatchInfo = `
                        <div class="dispatch-status-info">
                            <p><strong><i class="fas fa-truck"></i> Dispatched On:</strong> ${dispatchDate.toLocaleString()}</p>
                            ${request.dispatchedBy ? `<p><strong><i class="fas fa-user-check"></i> Dispatched By:</strong> ${request.dispatchedBy}</p>` : ''}
                            ${request.employeeReceiptSignature ? `
                                <p><strong><i class="fas fa-signature"></i> Employee Signature:</strong> 
                                    <span class="signature-thumbnail has-signature">
                                        <i class="fas fa-check"></i> Recorded
                                    </span>
                                </p>
                                <div class="signature-display-small">
                                    <img src="${request.employeeReceiptSignature}" alt="Employee Signature">
                                </div>
                            ` : '<p><strong><i class="fas fa-signature"></i> Employee Signature:</strong> <span class="signature-thumbnail">Not Available</span></p>'}
                        </div>
                    `;
                }
                
                requestDiv.className = `request-item ${statusClass}`;
                requestDiv.innerHTML = `
                    ${statusBadge}
                    <p><strong><i class="fas fa-calendar-alt"></i> Date:</strong> ${request.date}</p>
                    <p><strong><i class="fas fa-clock"></i> Clock No.:</strong> ${request.clockNo}</p>
                    <p><strong><i class="fas fa-user"></i> Names:</strong> ${request.names}</p>
                    <p><strong><i class="fas fa-tags"></i> Category:</strong> ${request.category || 'N/A'} ${request.category === 'Charged' ? '<span class="status-badge status-charged">Charged</span>' : '<span class="status-badge status-uncharged">Uncharged</span>'}</p>
                    <p><strong><i class="fas fa-boxes"></i> Total Items:</strong> ${request.totalItems}</p>
                    <p><strong><i class="fas fa-money-bill-wave"></i> Total Cost:</strong> ${formatCurrency(request.totalCost || 0)}</p>
                    <p><strong><i class="fas fa-box"></i> Items Requested:</strong></p>
                    <ul>
                        ${Object.entries(request.items).map(([key, item]) => {
                            if (item.quantity > 0) {
                                const itemPriceAtRequest = item.itemPrice !== undefined ? item.itemPrice : (currentStock[key]?.costPrice !== undefined ? currentStock[key].costPrice : 0);
                                const itemTotal = item.quantity * itemPriceAtRequest;
                                return `<li><i class="fas fa-tshirt"></i> ${itemMap[key] ? itemMap[key].name : key}: Qty ${item.quantity}, Size/Color: ${item.size || item.color || item.type || 'N/A'} (Cost: ${formatCurrency(itemTotal)})</li>`;
                            }
                            return '';
                        }).join('')}
                    </ul>
                    <p><strong><i class="fas fa-signature"></i> Supervisor Sign:</strong> ${request.supervisorSign || 'N/A'}</p>
                    <p><strong><i class="fas fa-signature"></i> Employee Sign:</strong> ${request.employeeSign || 'N/A'}</p>
                    ${dispatchInfo}
                    <p class="text-xs text-gray-400 mt-2"><i class="fas fa-clock"></i> Submitted: ${request.timestamp ? new Date(request.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
                `;
            } else {
                // Pending dispatch
                statusClass = 'pending-dispatch';
                statusBadge = '<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending Dispatch</span>';
                
                dispatchActions = `
                    <div class="request-item-actions">
                        <button type="button" class="dispatch-button" data-request-id="${request.id}">
                            <i class="fas fa-truck"></i> Dispatch Now
                        </button>
                    </div>
                `;
                
                requestDiv.className = `request-item ${statusClass}`;
                requestDiv.innerHTML = `
                    ${statusBadge}
                    <p><strong><i class="fas fa-calendar-alt"></i> Date:</strong> ${request.date}</p>
                    <p><strong><i class="fas fa-clock"></i> Clock No.:</strong> ${request.clockNo}</p>
                    <p><strong><i class="fas fa-user"></i> Names:</strong> ${request.names}</p>
                    <p><strong><i class="fas fa-tags"></i> Category:</strong> ${request.category || 'N/A'} ${request.category === 'Charged' ? '<span class="status-badge status-charged">Charged</span>' : '<span class="status-badge status-uncharged">Uncharged</span>'}</p>
                    <p><strong><i class="fas fa-boxes"></i> Total Items:</strong> ${request.totalItems}</p>
                    <p><strong><i class="fas fa-money-bill-wave"></i> Total Cost:</strong> ${formatCurrency(request.totalCost || 0)}</p>
                    <p><strong><i class="fas fa-box"></i> Items Requested:</strong></p>
                    <ul>
                        ${Object.entries(request.items).map(([key, item]) => {
                            if (item.quantity > 0) {
                                const itemPriceAtRequest = item.itemPrice !== undefined ? item.itemPrice : (currentStock[key]?.costPrice !== undefined ? currentStock[key].costPrice : 0);
                                const itemTotal = item.quantity * itemPriceAtRequest;
                                return `<li><i class="fas fa-tshirt"></i> ${itemMap[key] ? itemMap[key].name : key}: Qty ${item.quantity}, Size/Color: ${item.size || item.color || item.type || 'N/A'} (Cost: ${formatCurrency(itemTotal)})</li>`;
                            }
                            return '';
                        }).join('')}
                    </ul>
                    <p><strong><i class="fas fa-signature"></i> Supervisor Sign:</strong> ${request.supervisorSign || 'N/A'}</p>
                    <p><strong><i class="fas fa-signature"></i> Employee Sign:</strong> ${request.employeeSign || 'N/A'}</p>
                    ${dispatchActions}
                    <p class="text-xs text-gray-400 mt-2"><i class="fas fa-clock"></i> Submitted: ${request.timestamp ? new Date(request.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
                `;
            }

            return requestDiv;
        }

        // Function to render requests into their respective containers and calculate stats
        function renderRequests(requests) {
            pendingDispatchContainer.innerHTML = '';
            dispatchedContainer.innerHTML = '';
            chargedRequestsContainer.innerHTML = '';
            unchargedRequestsContainer.innerHTML = '';

            let totalRequests = requests.length;
            let chargedRequestsCount = 0;
            let unchargedRequestsCount = 0;
            let pendingDispatchCount = 0;
            let dispatchedCount = 0;
            let totalItemsAcrossAllRequests = 0;
            let totalChargedCost = 0;
            let totalUnchargedCost = 0;

            const itemRequestStats = {
                tShirt: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                golfer: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                jrb: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                jnb: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                beanie: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                skirt: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                abaya: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                caps: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                shoes: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                gloves: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                dustCoats: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
                reflector: { total: 0, charged: 0, uncharged: 0, chargedCost: 0, unchargedCost: 0 },
            };

            requests.forEach(request => {
                const requestDiv = createRequestItemHtml(request);

                // Add event listener for dispatch buttons
                if (request.dispatchStatus !== 'dispatched') {
                    const dispatchBtn = requestDiv.querySelector('.dispatch-button');
                    if (dispatchBtn) {
                        dispatchBtn.addEventListener('click', () => {
                            showSignatureModal(request);
                        });
                    }
                }

                // Categorize by dispatch status
                if (request.dispatchStatus === 'dispatched') {
                    dispatchedCount++;
                    dispatchedContainer.appendChild(requestDiv);
                } else {
                    pendingDispatchCount++;
                    pendingDispatchContainer.appendChild(requestDiv);
                }

                // Also categorize by charge type for the requests section
                if (request.category === 'Charged') {
                    chargedRequestsCount++;
                    chargedRequestsContainer.appendChild(requestDiv.cloneNode(true));
                } else if (request.category === 'Uncharged') {
                    unchargedRequestsCount++;
                    unchargedRequestsContainer.appendChild(requestDiv.cloneNode(true));
                }

                // Update statistics
                if (request.category === 'Charged') {
                    totalChargedCost += request.totalCost || 0;
                } else if (request.category === 'Uncharged') {
                    totalUnchargedCost += request.totalCost || 0;
                }

                totalItemsAcrossAllRequests += request.totalItems || 0;

                // Update item-wise statistics
                for (const itemType in request.items) {
                    const quantity = request.items[itemType].quantity || 0;
                    const itemPriceAtRequest = request.items[itemType].itemPrice !== undefined ? request.items[itemType].itemPrice : (currentStock[itemType]?.costPrice !== undefined ? currentStock[itemType].costPrice : 0);
                    const itemTotalCost = quantity * itemPriceAtRequest;

                    if (itemRequestStats[itemType]) {
                        itemRequestStats[itemType].total += quantity;
                        if (request.category === 'Charged') {
                            itemRequestStats[itemType].charged += quantity;
                            itemRequestStats[itemType].chargedCost += itemTotalCost;
                        } else if (request.category === 'Uncharged') {
                            itemRequestStats[itemType].uncharged += quantity;
                            itemRequestStats[itemType].unchargedCost += itemTotalCost;
                        }
                    }
                }
            });

            // Update message displays
            if (pendingDispatchCount === 0) {
                noPendingDispatchMessage.style.display = 'block';
            } else {
                noPendingDispatchMessage.style.display = 'none';
            }

            if (dispatchedCount === 0) {
                noDispatchedMessage.style.display = 'block';
            } else {
                noDispatchedMessage.style.display = 'none';
            }

            if (chargedRequestsCount === 0) {
                noChargedRequestsMessage.style.display = 'block';
            } else {
                noChargedRequestsMessage.style.display = 'none';
            }

            if (unchargedRequestsCount === 0) {
                noUnchargedRequestsMessage.style.display = 'block';
            } else {
                noUnchargedRequestsMessage.style.display = 'none';
            }

            // Update dashboard stats
            document.getElementById('totalRequestsStat').innerText = totalRequests;
            document.getElementById('chargedRequestsStat').innerText = chargedRequestsCount;
            document.getElementById('unchargedRequestsStat').innerText = unchargedRequestsCount;
            document.getElementById('pendingDispatchStat').innerText = pendingDispatchCount;
            document.getElementById('dispatchedStat').innerText = dispatchedCount;
            document.getElementById('totalItemsStat').innerText = totalItemsAcrossAllRequests;

            // Update stats section
            document.getElementById('totalRequestsStat2').innerText = totalRequests;
            document.getElementById('chargedRequestsStat2').innerText = chargedRequestsCount;
            document.getElementById('unchargedRequestsStat2').innerText = unchargedRequestsCount;
            document.getElementById('pendingDispatchStat2').innerText = pendingDispatchCount;
            document.getElementById('dispatchedStat2').innerText = dispatchedCount;
            document.getElementById('totalItemsStat2').innerText = totalItemsAcrossAllRequests;
            document.getElementById('totalChargedCostStat').innerText = formatCurrency(totalChargedCost);
            document.getElementById('totalUnchargedCostStat').innerText = formatCurrency(totalUnchargedCost);

            // Update item statistics
            document.getElementById('tShirtTotalStat').innerText = itemRequestStats.tShirt.total;
            document.getElementById('tShirtChargedStat').innerText = itemRequestStats.tShirt.charged;
            document.getElementById('tShirtUnchargedStat').innerText = itemRequestStats.tShirt.uncharged;
            document.getElementById('tShirtChargedCostStat').innerText = formatCurrency(itemRequestStats.tShirt.chargedCost);
            document.getElementById('tShirtUnchargedCostStat').innerText = formatCurrency(itemRequestStats.tShirt.unchargedCost);

            document.getElementById('golferTotalStat').innerText = itemRequestStats.golfer.total;
            document.getElementById('golferChargedStat').innerText = itemRequestStats.golfer.charged;
            document.getElementById('golferUnchargedStat').innerText = itemRequestStats.golfer.uncharged;
            document.getElementById('golferChargedCostStat').innerText = formatCurrency(itemRequestStats.golfer.chargedCost);
            document.getElementById('golferUnchargedCostStat').innerText = formatCurrency(itemRequestStats.golfer.unchargedCost);

            document.getElementById('jrbTotalStat').innerText = itemRequestStats.jrb.total;
            document.getElementById('jrbChargedStat').innerText = itemRequestStats.jrb.charged;
            document.getElementById('jrbUnchargedStat').innerText = itemRequestStats.jrb.uncharged;
            document.getElementById('jrbChargedCostStat').innerText = formatCurrency(itemRequestStats.jrb.chargedCost);
            document.getElementById('jrbUnchargedCostStat').innerText = formatCurrency(itemRequestStats.jrb.unchargedCost);

            document.getElementById('beanieTotalStat').innerText = itemRequestStats.beanie.total;
            document.getElementById('beanieChargedStat').innerText = itemRequestStats.beanie.charged;
            document.getElementById('beanieUnchargedStat').innerText = itemRequestStats.beanie.uncharged;
            document.getElementById('beanieChargedCostStat').innerText = formatCurrency(itemRequestStats.beanie.chargedCost);
            document.getElementById('beanieUnchargedCostStat').innerText = formatCurrency(itemRequestStats.beanie.unchargedCost);

            document.getElementById('skirtTotalStat').innerText = itemRequestStats.skirt.total;
            document.getElementById('skirtChargedStat').innerText = itemRequestStats.skirt.charged;
            document.getElementById('skirtUnchargedStat').innerText = itemRequestStats.skirt.uncharged;
            document.getElementById('skirtChargedCostStat').innerText = formatCurrency(itemRequestStats.skirt.chargedCost);
            document.getElementById('skirtUnchargedCostStat').innerText = formatCurrency(itemRequestStats.skirt.unchargedCost);

            document.getElementById('abayaTotalStat').innerText = itemRequestStats.abaya.total;
            document.getElementById('abayaChargedStat').innerText = itemRequestStats.abaya.charged;
            document.getElementById('abayaUnchargedStat').innerText = itemRequestStats.abaya.uncharged;
            document.getElementById('abayaChargedCostStat').innerText = formatCurrency(itemRequestStats.abaya.chargedCost);
            document.getElementById('abayaUnchargedCostStat').innerText = formatCurrency(itemRequestStats.abaya.unchargedCost);

            document.getElementById('capsTotalStat').innerText = itemRequestStats.caps.total;
            document.getElementById('capsChargedStat').innerText = itemRequestStats.caps.charged;
            document.getElementById('capsUnchargedStat').innerText = itemRequestStats.caps.uncharged;
            document.getElementById('capsChargedCostStat').innerText = formatCurrency(itemRequestStats.caps.chargedCost);
            document.getElementById('capsUnchargedCostStat').innerText = formatCurrency(itemRequestStats.caps.unchargedCost);

            document.getElementById('shoesTotalStat').innerText = itemRequestStats.shoes.total;
            document.getElementById('shoesChargedStat').innerText = itemRequestStats.shoes.charged;
            document.getElementById('shoesUnchargedStat').innerText = itemRequestStats.shoes.uncharged;
            document.getElementById('shoesChargedCostStat').innerText = formatCurrency(itemRequestStats.shoes.chargedCost);
            document.getElementById('shoesUnchargedCostStat').innerText = formatCurrency(itemRequestStats.shoes.unchargedCost);

            document.getElementById('glovesTotalStat').innerText = itemRequestStats.gloves.total;
            document.getElementById('glovesChargedStat').innerText = itemRequestStats.gloves.charged;
            document.getElementById('glovesUnchargedStat').innerText = itemRequestStats.gloves.uncharged;
            document.getElementById('glovesChargedCostStat').innerText = formatCurrency(itemRequestStats.gloves.chargedCost);
            document.getElementById('glovesUnchargedCostStat').innerText = formatCurrency(itemRequestStats.gloves.unchargedCost);

            document.getElementById('dustCoatsTotalStat').innerText = itemRequestStats.dustCoats.total;
            document.getElementById('dustCoatsChargedStat').innerText = itemRequestStats.dustCoats.charged;
            document.getElementById('dustCoatsUnchargedStat').innerText = itemRequestStats.dustCoats.uncharged;
            document.getElementById('dustCoatsChargedCostStat').innerText = formatCurrency(itemRequestStats.dustCoats.chargedCost);
            document.getElementById('dustCoatsUnchargedCostStat').innerText = formatCurrency(itemRequestStats.dustCoats.unchargedCost);

            document.getElementById('reflectorTotalStat').innerText = itemRequestStats.reflector.total;
            document.getElementById('reflectorChargedStat').innerText = itemRequestStats.reflector.charged;
            document.getElementById('reflectorUnchargedStat').innerText = itemRequestStats.reflector.uncharged;
            document.getElementById('reflectorChargedCostStat').innerText = formatCurrency(itemRequestStats.reflector.chargedCost);
            document.getElementById('reflectorUnchargedCostStat').innerText = formatCurrency(itemRequestStats.reflector.unchargedCost);

            console.log("Requests and stats updated from Firestore.");
        }

        // Listen for real-time updates from Firestore
        function listenForRequests() {
            if (!isAuthReady || !currentUserId) {
                console.warn("Firestore not ready or user not authenticated.");
                return;
            }

            console.log("Setting up requests listener...");
            const requestsCollectionRef = collection(db, `artifacts/${appId}/public/data/uniformRequests`);
            const q = query(requestsCollectionRef);

            onSnapshot(q, (snapshot) => {
                const requests = [];
                snapshot.forEach((doc) => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                requests.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                renderRequests(requests);
            }, (error) => {
                console.error("Error listening to requests:", error);
                updateConnectionStatus(false);
                if (error.code === 'permission-denied') {
                    showMessageBox("Permission denied accessing requests. Please check Firebase Security Rules.");
                } else if (error.code === 'unavailable') {
                    showMessageBox("Firestore service unavailable. Please check your connection.");
                } else {
                    showMessageBox("Error loading requests: " + error.message);
                }
            });
        }

        // Handle form submission
        uniformForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!isAuthReady || !currentUserId) {
                showMessageBox("Application is still setting up. Please wait a moment and try again.");
                return;
            }

            const formData = {
                date: document.getElementById('date').value,
                clockNo: document.getElementById('clockNo').value,
                names: document.getElementById('names').value,
                category: document.getElementById('category').value,
                items: {
                    tShirt: {
                        quantity: parseInt(document.getElementById('tShirtQty').value) || 0,
                        size: document.getElementById('tShirtSize').value,
                        itemPrice: currentStock.tShirt?.costPrice !== undefined ? currentStock.tShirt.costPrice : 0
                    },
                    golfer: {
                        quantity: parseInt(document.getElementById('golferQty').value) || 0,
                        size: document.getElementById('golferSize').value,
                        itemPrice: currentStock.golfer?.costPrice !== undefined ? currentStock.golfer.costPrice : 0
                    },
                    jrb: {
                        quantity: parseInt(document.getElementById('jrbQty').value) || 0,
                        size: document.getElementById('jrbSize').value,
                        itemPrice: currentStock.jrb?.costPrice !== undefined ? currentStock.jrb.costPrice : 0
                    },
                    jnb: {
                        quantity: parseInt(document.getElementById('jnbQty').value) || 0,
                        size: document.getElementById('jnbSize').value,
                        itemPrice: currentStock.jnb?.costPrice !== undefined ? currentStock.jnb.costPrice : 0
                    },
                    beanie: {
                        quantity: parseInt(document.getElementById('beanieQty').value) || 0,
                        color: document.getElementById('beanieColor').value,
                        itemPrice: currentStock.beanie?.costPrice !== undefined ? currentStock.beanie.costPrice : 0
                    },
                    skirt: {
                        quantity: parseInt(document.getElementById('skirtQty').value) || 0,
                        size: document.getElementById('skirtSize').value,
                        itemPrice: currentStock.skirt?.costPrice !== undefined ? currentStock.skirt.costPrice : 0
                    },
                    abaya: {
                        quantity: parseInt(document.getElementById('abayaQty').value) || 0,
                        size: document.getElementById('abayaSize').value,
                        itemPrice: currentStock.abaya?.costPrice !== undefined ? currentStock.abaya.costPrice : 0
                    },
                    caps: {
                        quantity: parseInt(document.getElementById('capsQty').value) || 0,
                        size: document.getElementById('capsSize').value,
                        itemPrice: currentStock.caps?.costPrice !== undefined ? currentStock.caps.costPrice : 0
                    },
                    shoes: {
                        quantity: parseInt(document.getElementById('shoesQty').value) || 0,
                        size: document.getElementById('shoesSize').value,
                        itemPrice: currentStock.shoes?.costPrice !== undefined ? currentStock.shoes.costPrice : 0
                    },
                    gloves: {
                        quantity: parseInt(document.getElementById('glovesQty').value) || 0,
                        type: document.getElementById('glovesType').value,
                        itemPrice: currentStock.gloves?.costPrice !== undefined ? currentStock.gloves.costPrice : 0
                    },
                    dustCoats: {
                        quantity: parseInt(document.getElementById('dustCoatsQty').value) || 0,
                        size: document.getElementById('dustCoatsSize').value,
                        itemPrice: currentStock.dustCoats?.costPrice !== undefined ? currentStock.dustCoats.costPrice : 0
                    },
                    reflector: {
                        quantity: parseInt(document.getElementById('reflectorQty').value) || 0,
                        size: document.getElementById('reflectorSize').value,
                        itemPrice: currentStock.reflector?.costPrice !== undefined ? currentStock.reflector.costPrice : 0
                    }
                },
                totalItems: parseInt(document.getElementById('total').value) || 0,
                totalCost: parseFloat(totalCostInput.value.replace('R ', '')) || 0,
                supervisorSign: document.getElementById('supervisorSign').value,
                employeeSign: document.getElementById('employeeSign').value,
                timestamp: serverTimestamp(),
                submittedBy: currentUserId,
                dispatchStatus: 'pending' // New requests start as pending dispatch
            };

            if (!formData.date || !formData.clockNo || !formData.names || !formData.category) {
                showMessageBox("Please fill in all required employee details and select a category.");
                return;
            }

            const hasRequestedItems = Object.values(formData.items).some(item => item.quantity > 0);
            if (!hasRequestedItems) {
                showMessageBox("Please request at least one uniform item.");
                return;
            }

            const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockDocRef);
                    if (!stockDoc.exists()) {
                        throw new Error("Stock data not found. Please refresh page.");
                    }

                    const currentStockInDb = stockDoc.data();
                    const newStockData = JSON.parse(JSON.stringify(currentStockInDb));
                    let insufficientStockMessage = "";

                    const deductions = {};
                    for (const itemType in formData.items) {
                        const requestedQty = formData.items[itemType].quantity;
                        if (requestedQty > 0) {
                            const requestedSizeOrColor = formData.items[itemType].size || formData.items[itemType].color || formData.items[itemType].type;

                            if (!requestedSizeOrColor || requestedSizeOrColor === 'N/A') {
                                insufficientStockMessage += `Please select a size/color for ${itemMap[itemType].name}.\n`;
                                continue;
                            }

                            if (!newStockData[itemType]) {
                                newStockData[itemType] = {};
                            }
                            if (newStockData[itemType][requestedSizeOrColor] === undefined) {
                                newStockData[itemType][requestedSizeOrColor] = 0;
                            }

                            const availableStock = newStockData[itemType][requestedSizeOrColor];

                            if (requestedQty > availableStock) {
                                insufficientStockMessage += `Insufficient stock for ${itemMap[itemType].name} (Size/Color: ${requestedSizeOrColor}). Requested: ${requestedQty}, Available: ${availableStock}.\n`;
                            } else {
                                newStockData[itemType][requestedSizeOrColor] -= requestedQty;
                                if (!deductions[itemType]) deductions[itemType] = {};
                                deductions[itemType][requestedSizeOrColor] = requestedQty;
                            }
                        }
                    }

                    if (insufficientStockMessage) {
                        throw new Error(insufficientStockMessage);
                    }

                    transaction.update(stockDocRef, newStockData);
                    const newRequestDocRef = doc(collection(db, `artifacts/${appId}/public/data/uniformRequests`));
                    transaction.set(newRequestDocRef, formData);

                    for (const itemType in deductions) {
                        for (const sizeOrColorDeducted in deductions[itemType]) {
                            await recordStockAdjustment(
                                itemType,
                                -deductions[itemType][sizeOrColorDeducted],
                                newStockData[itemType][sizeOrColorDeducted],
                                formData.names,
                                "Request Deduction",
                                formData.items[itemType].itemPrice,
                                sizeOrColorDeducted
                            );
                        }
                    }
                });

                console.log("Uniform request submitted and stock updated successfully.");
                showMessageBox("Uniform request submitted successfully! The request is now pending dispatch.");
                uniformForm.reset();
                calculateTotals();
            }
            catch (e) {
                console.error("Error during transaction:", e);
                if (e.message.includes("Insufficient stock")) {
                    showMessageBox(e.message);
                } else {
                    showMessageBox("Error submitting request or updating stock. Please try again. Details: " + e.message);
                }
            }
        });

        // Handle form reset
        uniformForm.addEventListener('reset', function() {
            quantityInputs.forEach(input => {
                input.value = 0;
            });
            document.querySelectorAll('select[id$="Size"], select[id$="Color"], select[id$="Type"]').forEach(select => {
                select.value = "";
            });
            document.getElementById('category').value = "";
            calculateTotals();
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
        });

        // Handle Clear All Data button click
        clearAllDataBtn.addEventListener('click', () => {
            showMessageBox("Are you sure you want to delete ALL uniform request data AND reset stock levels? This action cannot be undone.", 'confirm', async (confirmed) => {
                if (confirmed) {
                    if (!isAuthReady || !currentUserId) {
                        showMessageBox("Application is not ready. Please wait for Firebase to initialize.");
                        return;
                    }

                    try {
                        const requestsCollectionRef = collection(db, `artifacts/${appId}/public/data/uniformRequests`);
                        const requestsQuerySnapshot = await getDocs(query(requestsCollectionRef));
                        const batch = writeBatch(db);
                        requestsQuerySnapshot.forEach((document) => {
                            batch.delete(doc(db, `artifacts/${appId}/public/data/uniformRequests`, document.id));
                        });

                        const stockHistoryCollectionRef = collection(db, `artifacts/${appId}/public/data/stockAdjustments`);
                        const stockHistoryQuerySnapshot = await getDocs(query(stockHistoryCollectionRef));
                        stockHistoryQuerySnapshot.forEach((document) => {
                            batch.delete(doc(db, `artifacts/${appId}/public/data/stockAdjustments`, document.id));
                        });

                        const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');
                        batch.set(stockDocRef, initialStockLevels);

                        await batch.commit();
                        console.log("All uniform request data cleared and stock reset to initial levels successfully.");
                        showMessageBox("All uniform request data has been cleared and stock levels reset to initial quantities.");
                    } catch (e) {
                        console.error("Error clearing all data or resetting stock: ", e);
                        showMessageBox("Error clearing data or resetting stock. Please check console for details.");
                    }
                }
            });
        });

        // Handle Toggle Stats button click
        toggleStatsBtn.addEventListener('click', () => {
            const statsContent = document.getElementById('statsContent');
            const statsToggle = document.getElementById('statsToggle');
            
            if (statsContent.style.maxHeight && statsContent.style.maxHeight !== '0px') {
                // Collapse
                statsContent.style.maxHeight = '0px';
                statsContent.classList.remove('expanded');
                statsToggle.classList.add('collapsed');
            } else {
                // Expand
                statsContent.style.maxHeight = statsContent.scrollHeight + "px";
                statsContent.classList.add('expanded');
                statsToggle.classList.remove('collapsed');
            }
        });

        // Handle Add Stock button click
        addStockBtn.addEventListener('click', async () => {
            if (!isAuthReady || !currentUserId) {
                showMessageBox("Application is not ready. Please wait for Firebase to initialize.");
                return;
            }

            const selectedItem = addStockItemSelect.value;
            const sizeOrColor = addStockSizeColorSelect.value;
            const quantityToAdd = parseInt(addStockQuantityInput.value);
            const costPrice = parseFloat(addStockCostPrice.value);
            const adjustedBy = addStockAdjustedBy.value.trim();

            if (!selectedItem) {
                showMessageBox("Please select an item to add stock for.");
                return;
            }
            if (!sizeOrColor || sizeOrColor === 'N/A') {
                showMessageBox("Please select a size/color for item.");
                return;
            }
            if (isNaN(quantityToAdd) || quantityToAdd <= 0) {
                showMessageBox("Please enter a valid quantity to add (must be a positive number).");
                return;
            }
            if (isNaN(costPrice) || costPrice < 0) {
                showMessageBox("Please enter a valid cost price (must be a non-negative number).");
                return;
            }
            if (!adjustedBy) {
                showMessageBox("Please enter your name as person adding stock.");
                return;
            }

            const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockDocRef);
                    let currentStockInDb = {};
                    if (stockDoc.exists()) {
                        currentStockInDb = stockDoc.data();
                    } else {
                        for (const itemType in initialStockLevels) {
                            currentStockInDb[itemType] = {};
                            let relevantOptions = [];
                            if (itemType === 'beanie') {
                                relevantOptions = colors;
                            } else if (itemType === 'skirt' || itemType === 'dustCoats') {
                                relevantOptions = skirtSizes;
                            } else if (itemType === 'shoes') {
                                relevantOptions = shoeSizes;
                            } else if (itemType === 'gloves') {
                                relevantOptions = gloveTypes;
                            } else if (itemType === 'caps' || itemType === 'reflector') {
                                relevantOptions = noSizeOption;
                            } else if (itemType === 'abaya') {
                                relevantOptions = [...sizes, ...noSizeOption];
                            } else {
                                relevantOptions = sizes;
                            }
                            relevantOptions.forEach(option => {
                                currentStockInDb[itemType][option] = 0;
                            });
                            currentStockInDb[itemType].costPrice = 0;
                        }
                        console.log("Stock document not found, initializing with zero levels for add stock.");
                    }

                    const newStockData = JSON.parse(JSON.stringify(currentStockInDb));

                    if (!newStockData[selectedItem]) {
                        newStockData[selectedItem] = {};
                    }
                    if (newStockData[selectedItem][sizeOrColor] === undefined) {
                        newStockData[selectedItem][sizeOrColor] = 0;
                    }

                    const currentQty = newStockData[selectedItem][sizeOrColor];
                    const updatedQty = currentQty + quantityToAdd;

                    newStockData[selectedItem][sizeOrColor] = updatedQty;
                    newStockData[selectedItem].costPrice = costPrice;
                    newStockData.lastAdjustedBy = adjustedBy;
                    newStockData.lastAdjustedAt = serverTimestamp();

                    transaction.set(stockDocRef, newStockData);

                    await recordStockAdjustment(
                        selectedItem,
                        quantityToAdd,
                        updatedQty,
                        adjustedBy,
                        "Add Stock",
                        costPrice,
                        sizeOrColor
                    );
                });

                showMessageBox(`${quantityToAdd} units of ${itemMap[selectedItem].name} (Size/Color: ${sizeOrColor}) added to stock successfully by ${adjustedBy} at ${formatCurrency(costPrice)} per item!`);
                addStockItemSelect.value = "";
                addStockSizeColorSelect.value = "";
                addStockQuantityInput.value = 1;
                addStockCostPrice.value = 0.00;
                addStockAdjustedBy.value = "";
            } catch (e) {
                console.error("Error adding stock:", e);
                showMessageBox("Error adding stock. Please try again. Details: " + e.message);
            }
        });

        // Handle Set Stock Quantity button click
        setStockBtn.addEventListener('click', async () => {
            if (!isAuthReady || !currentUserId) {
                showMessageBox("Application is not ready. Please wait for Firebase to initialize.");
                return;
            }

            const selectedItem = setStockItemSelect.value;
            const sizeOrColor = setStockSizeColorSelect.value;
            const quantityToSet = parseInt(setStockQuantityInput.value);
            const adjustedBy = setStockAdjustedBy.value.trim();

            if (!selectedItem) {
                showMessageBox("Please select an item to set stock for.");
                return;
            }
            if (!sizeOrColor || sizeOrColor === 'N/A') {
                showMessageBox("Please select a size/color for item.");
                return;
            }
            if (isNaN(quantityToSet) || quantityToSet < 0) {
                showMessageBox("Please enter a valid quantity to set (must be a non-negative number).");
                return;
            }
            if (!adjustedBy) {
                showMessageBox("Please enter your name as person adjusting stock.");
                return;
            }

            const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockDocRef);
                    let currentStockInDb = {};
                    if (stockDoc.exists()) {
                        currentStockInDb = stockDoc.data();
                    } else {
                        for (const itemType in initialStockLevels) {
                            currentStockInDb[itemType] = {};
                            let relevantOptions = [];
                            if (itemType === 'beanie') {
                                relevantOptions = colors;
                            } else if (itemType === 'skirt' || itemType === 'dustCoats') {
                                relevantOptions = skirtSizes;
                            } else if (itemType === 'shoes') {
                                relevantOptions = shoeSizes;
                            } else if (itemType === 'gloves') {
                                relevantOptions = gloveTypes;
                            } else if (itemType === 'caps' || itemType === 'reflector') {
                                relevantOptions = noSizeOption;
                            } else if (itemType === 'abaya') {
                                relevantOptions = [...sizes, ...noSizeOption];
                            } else {
                                relevantOptions = sizes;
                            }
                            relevantOptions.forEach(option => {
                                currentStockInDb[itemType][option] = 0;
                            });
                            currentStockInDb[itemType].costPrice = 0;
                        }
                        console.log("Stock document not found, initialized with zero levels for set stock.");
                    }

                    const newStockData = JSON.parse(JSON.stringify(currentStockInDb));

                    if (!newStockData[selectedItem]) {
                        newStockData[selectedItem] = {};
                    }
                    if (newStockData[selectedItem][sizeOrColor] === undefined) {
                        newStockData[selectedItem][sizeOrColor] = 0;
                    }

                    const oldQty = newStockData[selectedItem][sizeOrColor];
                    const quantityChange = quantityToSet - oldQty;

                    newStockData[selectedItem][sizeOrColor] = quantityToSet;
                    newStockData.lastAdjustedBy = adjustedBy;
                    newStockData.lastAdjustedAt = serverTimestamp();

                    transaction.set(stockDocRef, newStockData);

                    await recordStockAdjustment(
                        selectedItem,
                        quantityChange,
                        quantityToSet,
                        adjustedBy,
                        "Set Stock",
                        null,
                        sizeOrColor
                    );
                });

                showMessageBox(`${itemMap[selectedItem].name} stock set to ${quantityToSet} (Size/Color: ${sizeOrColor}) by ${adjustedBy}!`);
                setStockItemSelect.value = "";
                setStockSizeColorSelect.value = "";
                setStockQuantityInput.value = 0;
                setStockAdjustedBy.value = "";
            } catch (e) {
                console.error("Error setting stock:", e);
                showMessageBox("Error setting stock. Please try again. Details: " + e.message);
            }
        });

        // Handle Clear All Stock button click
        clearAllStockBtn.addEventListener('click', () => {
            showMessageBox("Are you sure you want to clear ALL stock levels to zero? This action cannot be undone.", 'confirm', async (confirmed) => {
                if (confirmed) {
                    if (!isAuthReady || !currentUserId) {
                        showMessageBox("Application is not ready. Please wait for Firebase to initialize.");
                        return;
                    }

                    const adjustedBy = clearStockAdjustedBy.value.trim();
                    if (!adjustedBy) {
                        showMessageBox("Please enter your name as person clearing stock.");
                        return;
                    }

                    const stockDocRef = doc(db, `artifacts/${appId}/public/data/uniformStock`, 'currentStock');

                    try {
                        await runTransaction(db, async (transaction) => {
                            const stockDoc = await transaction.get(stockDocRef);
                            let currentStockInDb = {};
                            if (stockDoc.exists()) {
                                currentStockInDb = stockDoc.data();
                            } else {
                                for (const itemType in initialStockLevels) {
                                    currentStockInDb[itemType] = {};
                                    let relevantOptions = [];
                                    if (itemType === 'beanie') {
                                        relevantOptions = colors;
                                    } else if (itemType === 'skirt' || itemType === 'dustCoats') {
                                        relevantOptions = skirtSizes;
                                    } else if (itemType === 'shoes') {
                                        relevantOptions = shoeSizes;
                                    } else if (itemType === 'gloves') {
                                        relevantOptions = gloveTypes;
                                    } else if (itemType === 'caps' || itemType === 'reflector') {
                                        relevantOptions = noSizeOption;
                                    } else if (itemType === 'abaya') {
                                        relevantOptions = [...sizes, ...noSizeOption];
                                    } else {
                                        relevantOptions = sizes;
                                    }
                                    relevantOptions.forEach(option => {
                                        currentStockInDb[itemType][option] = 0;
                                    });
                                    currentStockInDb[itemType].costPrice = 0;
                                }
                                console.log("Stock document not found, initializing with zero levels for clear stock.");
                            }

                            const zeroStockLevelsNested = {};
                            let totalChange = 0;
                            for (const itemType in initialStockLevels) {
                                zeroStockLevelsNested[itemType] = {};
                                let relevantOptions = [];
                                if (itemType === 'beanie') {
                                    relevantOptions = colors;
                                } else if (itemType === 'skirt' || itemType === 'dustCoats') {
                                    relevantOptions = skirtSizes;
                                } else if (itemType === 'shoes') {
                                    relevantOptions = shoeSizes;
                                } else if (itemType === 'gloves') {
                                    relevantOptions = gloveTypes;
                                } else if (itemType === 'caps' || itemType === 'reflector') {
                                    relevantOptions = noSizeOption;
                                } else if (itemType === 'abaya') {
                                    relevantOptions = [...sizes, ...noSizeOption];
                                } else {
                                    relevantOptions = sizes;
                                }
                                relevantOptions.forEach(option => {
                                    const oldQty = currentStockInDb[itemType]?.[option] || 0;
                                    totalChange -= oldQty;
                                    zeroStockLevelsNested[itemType][option] = 0;
                                });
                                zeroStockLevelsNested[itemType].costPrice = currentStockInDb[itemType]?.costPrice || 0;
                            }

                            console.log("Inside transaction: Setting stock to zero levels.");
                            transaction.set(stockDocRef, {
                                ...zeroStockLevelsNested,
                                lastAdjustedBy: adjustedBy,
                                lastAdjustedAt: serverTimestamp()
                            });

                            await recordStockAdjustment(
                                "all_items",
                                totalChange,
                                0,
                                adjustedBy,
                                "Clear All Stock",
                                null,
                                "All Sizes/Colors"
                            );
                        });
                        console.log("All stock levels reset to zero successfully.");
                        showMessageBox(`All stock levels have been reset to zero by ${adjustedBy}.`);
                        clearStockAdjustedBy.value = "";
                    } catch (e) {
                        console.error("Error clearing all stock to zero: ", e);
                        showMessageBox("Error clearing all stock to zero. Please check console for details.");
                    }
                }
            });
        });

        // Clear signature button
        document.getElementById('clearSignatureBtn').addEventListener('click', () => {
            if (signaturePad) {
                signaturePad.clear();
            }
        });

        // Cancel signature button
        document.getElementById('cancelSignatureBtn').addEventListener('click', () => {
            hideSignatureModal();
        });

        // Save signature button
        document.getElementById('saveSignatureBtn').addEventListener('click', async () => {
            if (signaturePad.isEmpty()) {
                showMessageBox("Please provide your signature before confirming dispatch.");
                return;
            }

            if (!currentRequestForDispatch) {
                showMessageBox("No request selected for dispatch.");
                return;
            }

            const signatureData = signaturePad.toDataURL('image/png'); // Get signature as PNG base64
            
            try {
                // Update request with dispatch information and signature
                const requestRef = doc(db, `artifacts/${appId}/public/data/uniformRequests`, currentRequestForDispatch.id);
                
                await updateDoc(requestRef, {
                    dispatchStatus: 'dispatched',
                    dispatchDate: serverTimestamp(),
                    dispatchSignature: signatureData,
                    dispatchedBy: currentUserId,
                    employeeReceiptSignature: signatureData,
                    employeeReceiptName: currentRequestForDispatch.names,
                    employeeClockNo: currentRequestForDispatch.clockNo
                });

                showMessageBox(`Uniform items dispatched successfully for ${currentRequestForDispatch.names} (Clock No: ${currentRequestForDispatch.clockNo}). Signature recorded.`);
                
                // Clear signature and hide modal
                signaturePad.clear();
                hideSignatureModal();
                
            } catch (error) {
                console.error("Error updating dispatch status:", error);
                showMessageBox("Error recording dispatch. Please try again.");
            }
        });

        // Handle window resize for signature pad
        window.addEventListener('resize', () => {
            if (signaturePad) {
                // Save current signature
                const data = signaturePad.toData();
                
                // Resize canvas using our helper
                const canvas = document.getElementById('signaturePad');
                const didResize = resizeCanvas(canvas);
                
                // Restore signature
                if (didResize) {
                    signaturePad.fromData(data);
                }
            }
        });

        console.log("Uniform Request Application with Signature Capture loaded and initialized.");
    </script>
</body>
</html>